<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Efici√™ncia - C3C</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: { c3c: { blue: '#2978FF', teal: '#1DDDBD', gray: '#F2F2F2' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .bg-c3c-gradient { background: linear-gradient(135deg, #2978FF 0%, #1DDDBD 100%); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-[#F8FAFC]">

    <div id="mobile-overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <%- include('partials/sidebar', { page: 'dashboard' }) %>

    <main class="flex-1 flex flex-col md:ml-64 relative w-full transition-all duration-300">
        
        <!-- HEADER -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleMenu()" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800">Minha Efici√™ncia üöÄ</h1>
                    <p class="text-xs text-gray-400 hidden sm:block">Acompanhe seu desempenho e banco de horas</p>
                </div>
            </div>
            
            <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 px-3 py-1.5">
                <i data-lucide="calendar" class="w-4 h-4 text-blue-500 mr-2"></i>
                <span id="current-period-name" class="text-sm font-bold text-gray-700">Carregando per√≠odo...</span>
            </div>
        </header>

        <!-- CONTE√öDO -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 fade-in">
            
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                
                <!-- KPI 1: EFICI√äNCIA -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="activity" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ades√£o / Efici√™ncia</span>
                        </div>
                        <div class="flex items-baseline gap-1 mt-4">
                            <span id="kpi-eficiencia" class="text-4xl font-extrabold text-gray-800">--</span>
                            <span class="text-sm text-gray-400 font-medium">%</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Horas Realizadas vs. Previstas</p>
                    </div>
                </div>

                <!-- KPI 2: BANCO DE HORAS -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-teal-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="clock" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Banco de Horas</span>
                        </div>
                        <div class="flex items-baseline gap-1 mt-4">
                            <span id="kpi-banco" class="text-4xl font-extrabold text-gray-800">--</span>
                            <span class="text-sm text-gray-400 font-medium">h</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Saldo acumulado geral</p>
                    </div>
                </div>

                <!-- KPI 3: PEND√äNCIAS -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-red-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-red-100 rounded-lg text-red-600"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Rascunhos</span>
                        </div>
                        <div class="flex items-baseline gap-1 mt-4">
                            <span id="kpi-pendentes" class="text-4xl font-extrabold text-gray-800">--</span>
                            <span class="text-sm text-gray-400 font-medium">h</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Necessitam envio/corre√ß√£o</p>
                    </div>
                </div>

                <!-- KPI 4: PREVISTO -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="target" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Meta do Per√≠odo</span>
                        </div>
                        <div class="flex items-baseline gap-1 mt-4">
                            <span id="kpi-alocadas" class="text-4xl font-extrabold text-gray-800">--</span>
                            <span class="text-sm text-gray-400 font-medium">h</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Baseado nas aloca√ß√µes ativas</p>
                    </div>
                </div>

            </div>

            <!-- CARD DE A√á√ÉO -->
            <div id="action-card" class="bg-gradient-to-r from-blue-600 to-blue-500 rounded-2xl p-6 md:p-8 text-white shadow-xl shadow-blue-200 hidden">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div>
                        <h3 class="text-2xl font-bold mb-2 flex items-center gap-2">
                            <i data-lucide="zap" class="w-6 h-6 text-yellow-300"></i>
                            Aten√ß√£o √†s Pend√™ncias!
                        </h3>
                        <p class="text-blue-100 max-w-lg text-sm md:text-base">
                            Voc√™ possui horas em "Rascunho" ou "Reprovadas". Regularize seus apontamentos para garantir o fechamento do ponto.
                        </p>
                    </div>
                    <a href="/timesheet" class="w-full md:w-auto text-center bg-white text-blue-600 font-bold px-6 py-3 rounded-xl hover:bg-blue-50 transition-colors shadow-md transform hover:-translate-y-1">
                        Ir para Timesheet
                    </a>
                </div>
            </div>

            <!-- LISTA DE PROJETOS -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="folder-kanban" class="w-5 h-5 text-gray-400"></i>
                    Meus Projetos Ativos
                </h3>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase">Projeto / Servi√ßo</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase">Cliente</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase text-right">Aloca√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="projects-list" class="divide-y divide-gray-50 text-sm text-gray-600">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">Carregando projetos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();
        const API_URL = '/api';

        // --- MENU MOBILE ---
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // --- DADOS ---
        document.addEventListener('DOMContentLoaded', () => { loadPeriods(); });

        async function loadPeriods() {
            try {
                const res = await fetch(`${API_URL}/periods?type=user`);
                if(res.status === 401) window.location.href = '/';
                const periods = await res.json();
                const display = document.getElementById('current-period-name');
                
                if(!periods || periods.length === 0) { 
                    display.innerText = 'Sem contratos ativos'; 
                    return; 
                }
                
                // Pega o per√≠odo mais recente (primeiro da lista)
                const current = periods[0];
                display.innerText = current.Name;
                
                // Dispara a carga dos dados
                loadDashboardKPIs(current.DataInicio__c, current.DataFim__c);
                loadMyProjects(current.DataInicio__c, current.DataFim__c);
            } catch (err) { 
                console.error(err);
                document.getElementById('current-period-name').innerText = 'Erro ao carregar';
            }
        }

        function triggerDataLoad(jsonDates) {
            if(!jsonDates) return;
            const dates = JSON.parse(jsonDates);
            loadDashboardKPIs(dates.start, dates.end);
            loadMyProjects(dates.start, dates.end);
        }

        async function loadDashboardKPIs(start, end) {
            const ids = ['kpi-alocadas', 'kpi-eficiencia', 'kpi-pendentes', 'kpi-banco'];
            const els = ids.map(id => document.getElementById(id));
            els.forEach(el => el.classList.add('animate-pulse'));

            try {
                // Adiciona scope=personal para usar a nova l√≥gica
                const res = await fetch(`${API_URL}/dashboard/metrics?inicio=${start}&fim=${end}&scope=personal`);
                if (res.ok) {
                    const data = await res.json();
                    
                    document.getElementById('kpi-alocadas').innerText = Math.round(data.totalAlocadas);
                    document.getElementById('kpi-pendentes').innerText = data.totalPendentes.toFixed(1);
                    document.getElementById('kpi-eficiencia').innerText = data.eficiencia;
                    document.getElementById('kpi-banco').innerText = data.saldoBanco.toFixed(2);

                    // Cores din√¢micas para Efici√™ncia
                    const elEfic = document.getElementById('kpi-eficiencia');
                    if(data.eficiencia > 110) elEfic.className = "text-4xl font-extrabold text-red-500";
                    else if(data.eficiencia >= 90) elEfic.className = "text-4xl font-extrabold text-teal-500";
                    else elEfic.className = "text-4xl font-extrabold text-blue-500";

                    // Cores din√¢micas para Banco
                    const elBanco = document.getElementById('kpi-banco');
                    if(data.saldoBanco < 0) elBanco.className = "text-4xl font-extrabold text-red-500";
                    else elBanco.className = "text-4xl font-extrabold text-teal-500";

                    // Card de Alerta
                    const actionCard = document.getElementById('action-card');
                    if(data.totalPendentes > 0) {
                        actionCard.classList.remove('hidden');
                        actionCard.classList.add('fade-in');
                    } else {
                        actionCard.classList.add('hidden');
                    }

                } else {
                    els.forEach(el => el.innerText = "-");
                }
            } catch (err) { console.error(err); } 
            finally { els.forEach(el => el.classList.remove('animate-pulse')); }
        }

        async function loadMyProjects(start, end) {
             const tbody = document.getElementById('projects-list');
             try {
                // Nova rota dedicada com percentual
                const res = await fetch(`${API_URL}/dashboard/allocations?inicio=${start}&fim=${end}`);
                
                if (!res.ok) throw new Error(`Erro na API: ${res.status}`);
                
                const data = await res.json();
                
                if(!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">Nenhuma aloca√ß√£o encontrada neste per√≠odo.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors";
                    tr.innerHTML = `
                        <td class="p-4 font-medium text-gray-800">${p.serviceName}</td>
                        <td class="p-4 text-gray-500">${p.accountName}</td>
                        <td class="p-4 text-right">
                            <span class="bg-blue-100 text-blue-700 py-1 px-3 rounded-full text-xs font-bold">
                                ${p.percent}%
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

             } catch(e) {
                 console.error("Erro ao carregar projetos:", e);
                 tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-400">Erro: ${e.message}</td></tr>`;
             }
        }
    </script>
</body>
</html>