<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Horas - C3C Workplace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: { c3c: { blue: '#2978FF', teal: '#1DDDBD' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .slide-over { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-over.closed { transform: translateX(100%); }
        .slide-over.open { transform: translateX(0); }
        .input-c3c { transition: all 0.2s; border: 1px solid #E2E8F0; }
        .input-c3c:focus { border-color: #2978FF; box-shadow: 0 0 0 3px rgba(41, 120, 255, 0.1); outline: none; }
        .input-c3c:disabled { background-color: #F3F4F6; color: #9CA3AF; cursor: not-allowed; border-color: #E5E7EB; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-[#F8FAFC]">

    <%- include('partials/sidebar') %>

    <main class="flex-1 flex flex-col md:ml-64 relative w-full overflow-hidden transition-all duration-300">
        
        <header class="h-auto bg-white border-b border-gray-200 flex flex-col px-8 py-4 shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')" class="md:hidden text-gray-400"><i data-lucide="menu"></i></button>
                    <h1 class="text-xl font-bold text-gray-800">Folha de Ponto</h1>
                    
                    <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg p-1 hidden sm:flex">
                        <button onclick="changePeriod(1)" class="p-1 hover:bg-white rounded shadow-sm text-gray-500 transition-colors" title="Anterior">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <span id="period-display" class="px-4 text-sm font-bold text-gray-700 min-w-[180px] text-center">Carregando...</span>
                        <button onclick="changePeriod(-1)" class="p-1 hover:bg-white rounded shadow-sm text-gray-500 transition-colors" title="Pr√≥ximo">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="submitPeriod()" class="hidden md:flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95">
                        <i data-lucide="send" class="w-4 h-4"></i> Enviar Folha M√™s
                    </button>
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-600 border border-blue-200">
                        <%= user.nome ? user.nome.charAt(0) : 'U' %>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Contratado</p>
                        <p class="text-xl font-extrabold text-slate-700" id="card-contratado">--h</p>
                    </div>
                    <div class="p-2 bg-white rounded-full text-slate-400"><i data-lucide="calendar-clock" class="w-5 h-5"></i></div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] uppercase font-bold text-blue-400 tracking-wider">Lan√ßado (M√™s)</p>
                        <p class="text-xl font-extrabold text-blue-700" id="card-realizado">--h</p>
                    </div>
                    <div class="p-2 bg-white rounded-full text-blue-400"><i data-lucide="check-circle" class="w-5 h-5"></i></div>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-gray-300" id="card-banco-bar"></div>
                    <div>
                        <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Saldo Banco (Total)</p>
                        <p class="text-xl font-extrabold text-gray-700" id="card-banco">--h</p>
                    </div>
                    <div class="p-2 bg-gray-50 rounded-full text-gray-400" id="card-banco-icon"><i data-lucide="scale" class="w-5 h-5"></i></div>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-3 flex flex-col justify-center items-center">
                    <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">Status Folha</p>
                    <span id="card-status-label" class="px-3 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded-full">Carregando...</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div class="flex flex-wrap gap-4 mb-6 bg-white p-4 rounded-lg border border-gray-100 shadow-sm items-center text-xs text-gray-600">
                <span class="font-bold text-gray-400 uppercase mr-2 border-r border-gray-200 pr-4">Legenda:</span>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full border border-gray-400"></span> Rascunho</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> Lan√ßado</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Aprovado</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Reprovado</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-500"></span> Fechado</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Faturado</div>
            </div>

            <div class="grid grid-cols-7 gap-4 mb-2 text-center">
                <div class="text-xs font-bold text-red-400 uppercase">Dom</div>
                <div class="text-xs font-bold text-gray-400 uppercase">Seg</div>
                <div class="text-xs font-bold text-gray-400 uppercase">Ter</div>
                <div class="text-xs font-bold text-gray-400 uppercase">Qua</div>
                <div class="text-xs font-bold text-gray-400 uppercase">Qui</div>
                <div class="text-xs font-bold text-gray-400 uppercase">Sex</div>
                <div class="text-xs font-bold text-gray-400 uppercase">S√°b</div>
            </div>

            <div class="grid grid-cols-7 gap-4" id="calendar-grid">
                <div class="col-span-7 text-center py-10 text-gray-400">Carregando...</div>
            </div>
        </div>

        <div id="slide-overlay" onclick="closeDayPanel()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-30 hidden transition-opacity opacity-0"></div>
        <div id="day-panel" class="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl z-40 slide-over closed flex flex-col">
            
            <div class="bg-gray-50 border-b border-gray-200 p-6 shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold px-2 py-1 rounded uppercase bg-blue-100 text-blue-700" id="panel-weekday">...</span>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800" id="panel-date">...</h2>
                    </div>
                    <button onclick="closeDayPanel()" class="p-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><i data-lucide="x"></i></button>
                </div>
                <div id="readonly-alert" class="hidden bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r shadow-sm mb-2"><p class="text-xs text-blue-700 font-medium" id="readonly-reason">Bloqueado.</p></div>
                <div id="rejection-alert" class="hidden bg-red-50 border-l-4 border-red-500 p-3 rounded-r shadow-sm mb-2"><p class="text-xs text-red-700 font-bold">Itens Reprovados.</p><p class="text-[10px] text-red-600" id="rejection-reason"></p></div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-white relative">
                
                <div class="mb-8">
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">ALOCA√á√ïES</h3>
                        <span class="text-[10px] text-gray-400 flex items-center gap-1"><i data-lucide="arrow-right" class="w-3 h-3"></i> Deslize</span>
                    </div>
                    <div id="allocations-list" class="flex overflow-x-auto gap-4 pb-2 -mx-2 px-2 no-scrollbar snap-x"></div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Atividades Lan√ßadas</h3>
                    <div id="entries-list" class="space-y-3"></div>
                </div>

                <div id="add-activity-container" class="bg-gray-50 rounded-xl p-5 border border-gray-200 shadow-inner transition-opacity">
                    <input type="hidden" id="input-entry-id">
                    
                    <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-blue-600"></i> <span id="form-title">Nova Atividade</span></h3>
                    
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Projeto</label>
                            <select id="input-project" onchange="resetActivitySearch()" class="w-full input-c3c p-2 rounded-lg text-sm bg-white"></select>
                        </div>
                        <div class="relative">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Atividade / Chamado</label>
                            <div class="relative">
                                <input type="text" id="input-activity-search" oninput="filterActivities()" onfocus="filterActivities()" placeholder="Busque ou digite para criar..." class="w-full input-c3c p-2 rounded-lg text-sm bg-white pr-8" autocomplete="off">
                                <button onclick="clearActivity()" id="btn-clear-activity" class="absolute right-2 top-2 text-gray-400 hidden hover:text-gray-600" type="button"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                            <input type="hidden" id="input-activity-id">
                            <ul id="activity-dropdown" class="hidden absolute z-[100] w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto"></ul>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Normais</label>
                            <input type="number" id="input-normal" value="0" min="0" max="8" step="0.5" onblur="sanitizeField(this)" oninput="validateRules('normal')" class="w-full input-c3c p-2 rounded-lg text-center font-bold text-gray-700">
                            <p id="msg-normal" class="text-[10px] text-red-500 mt-1 hidden font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Extras</label>
                            <input type="number" id="input-extra" value="0" min="0" step="0.5" onblur="sanitizeField(this)" oninput="validateRules('extra')" class="w-full input-c3c p-2 rounded-lg text-center font-bold text-gray-700 disabled:bg-gray-100 disabled:text-gray-400" disabled>
                            <p id="msg-extra" class="text-[10px] text-red-500 mt-1 hidden font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Aus√™ncia</label>
                            <input type="number" id="input-leave" value="0" min="0" max="8" step="0.5" onblur="sanitizeField(this)" oninput="validateRules('leave')" class="w-full input-c3c p-2 rounded-lg text-center font-bold text-gray-700">
                            <p id="msg-leave" class="text-[10px] text-red-500 mt-1 hidden font-medium"></p>
                        </div>
                    </div>

                    <div id="options-extra" class="hidden mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <label class="block text-[10px] font-bold text-blue-600 mb-2 uppercase">Destino Extra:</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 text-xs text-gray-700 cursor-pointer"><input type="radio" name="radio-extra" value="Banco" checked class="text-blue-600"> Banco</label>
                            <label class="flex items-center gap-2 text-xs text-gray-700 cursor-pointer"><input type="radio" name="radio-extra" value="Pagamento" class="text-blue-600"> Pagamento</label>
                        </div>
                    </div>

                    <div id="options-absence" class="hidden mb-4 p-3 bg-orange-50 rounded-lg border border-orange-100">
                        <label class="block text-[10px] font-bold text-orange-600 mb-2 uppercase">Tipo Aus√™ncia:</label>
                        <select id="select-absence-type" class="w-full p-1.5 text-xs border border-orange-200 rounded bg-white text-gray-700">
                            <option value="Abonada">Remunerada (Atestado)</option>
                            <option value="Desconto">N√£o Remunerada (Desconto)</option>
                            <option value="Banco">Abater Banco</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Justificativa <span id="req-justification" class="text-red-500 hidden">*</span></label>
                        <textarea id="input-reason" rows="2" placeholder="Obrigat√≥rio para Extras/Aus√™ncia..." class="w-full input-c3c p-2 rounded-lg text-sm bg-white"></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" id="btn-cancel-edit" onclick="resetForm()" class="hidden text-gray-500 px-3 py-2 text-xs font-bold hover:bg-gray-100 rounded">Cancelar</button>
                        <button type="button" id="btn-add-entry" onclick="addEntry()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md transition-transform active:scale-95">Adicionar</button>
                    </div>
                </div>
            </div>

            <div class="bg-white border-t border-gray-200 p-4 shrink-0 z-50 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.1)]">
                <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-100">
                    <div class="flex gap-4">
                        <div class="text-center">
                            <p class="text-[10px] uppercase font-bold text-gray-400">Normais</p>
                            <p class="text-sm font-bold text-gray-700" id="footer-normal">0.0h</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] uppercase font-bold text-gray-400">Aus√™ncias</p>
                            <p class="text-sm font-bold text-orange-600" id="footer-absence">0.0h</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] uppercase font-bold text-gray-400">Extras</p>
                            <p class="text-sm font-bold text-blue-600" id="footer-extra">0.0h</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold text-gray-400">Saldo Dia</p>
                        <p class="text-xl font-extrabold text-gray-400" id="footer-balance">+0.0h</p>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-500 font-medium" id="footer-status">Rascunho</p>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg font-bold text-sm hover:bg-gray-50 transition-colors" onclick="closeDayPanel()">Fechar</button>
                        <button id="btn-submit-day" onclick="submitDay()" class="hidden px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2">
                           <span>üöÄ</span> Lan√ßar Dia
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        
        let currentPeriods=[], currentPeriodIndex=0, currentGridData={}, currentOpenDayId=null;
        let currentOpenDate = null; // Data do dia aberto no painel
        let dayProjects=[], dayActivities=[], dayEntries=[];
        let projectAllocationMap = {}; 
        
        const DAILY_CONTRACT = 8.0; 
        const MAX_DAY_HOURS = 24.0;
        let isNonBusinessDay = false;

        document.addEventListener('DOMContentLoaded', loadPeriods);

        async function loadPeriods() {
            try {
                // Traz apenas per√≠odos do usu√°rio
                const res = await fetch('/api/periods?type=user');
                const data = await res.json();
                if(data.length>0) { 
                    currentPeriods=data; 
                    const today = new Date().toISOString().split('T')[0];
                    const idx = data.findIndex(p => today >= p.DataInicio__c && today <= p.DataFim__c);
                    currentPeriodIndex = idx >= 0 ? idx : 0; 
                    updateHeader(); 
                    loadCalendar(currentPeriods[currentPeriodIndex].Id); 
                }
                else document.getElementById('period-display').innerText="Sem per√≠odos";
            } catch(e){ console.error(e); }
        }
        
        function changePeriod(dir) {
            const idx = currentPeriodIndex + dir;
            if(idx >= 0 && idx < currentPeriods.length) { currentPeriodIndex=idx; updateHeader(); loadCalendar(currentPeriods[idx].Id); }
        }
        function updateHeader() { document.getElementById('period-display').innerText = currentPeriods[currentPeriodIndex].Name; }

        async function loadCalendar(pId) {
            const el = document.getElementById('calendar-grid');
            updateCards({ totalContratado:0, totalRealizado:0, saldoBancoTotal:0, variacaoPeriodo:0 }, true);
            el.innerHTML='<div class="col-span-7 text-center py-10 text-gray-400">Carregando...</div>';
            try {
                const res = await fetch(`/api/timesheet/calendar?periodId=${pId}`);
                const data = await res.json();
                currentGridData = data.grid;
                renderGrid(data.grid);
                if(data.summary) updateCards(data.summary);
            } catch(e) { el.innerHTML='<div class="text-red-400 text-center col-span-7">Erro ao carregar</div>'; }
        }

        function updateCards(summary, isLoading = false) {
            const lbl = document.getElementById('card-status-label');
            if(isLoading) {
                document.getElementById('card-contratado').innerText = '--';
                document.getElementById('card-realizado').innerText = '--';
                document.getElementById('card-banco').innerText = '--';
                lbl.className = "px-3 py-1 bg-gray-100 text-gray-400 text-xs font-bold rounded-full";
                lbl.innerText = "Carregando...";
                return;
            }
            document.getElementById('card-contratado').innerText = summary.totalContratado.toFixed(1) + 'h';
            document.getElementById('card-realizado').innerText = summary.totalRealizado.toFixed(1) + 'h';
            
            const saldo = summary.saldoBancoTotal || 0;
            const variacao = summary.variacaoPeriodo || 0;
            const saldoEl = document.getElementById('card-banco');
            const sign = saldo > 0 ? '+' : '';
            
            saldoEl.innerHTML = `<span class="text-lg">${sign}${saldo.toFixed(2)}h</span> <span class="text-xs text-gray-400 font-normal ml-1">(${variacao > 0 ? '+' : ''}${variacao.toFixed(1)}h m√™s)</span>`;

            if (saldo > 0) saldoEl.className = "font-extrabold text-teal-600 flex items-baseline";
            else if (saldo < 0) saldoEl.className = "font-extrabold text-red-600 flex items-baseline";
            else saldoEl.className = "font-extrabold text-gray-700 flex items-baseline";

            const st = summary.statusGeral || 'Em Aberto';
            lbl.innerText = st;
            const mapClass = { 'Faturado': 'amber', 'Fechado': 'slate', 'Aprovado': 'green', 'Aguardando Aprova√ß√£o': 'blue', 'Novo': 'gray' };
            const color = mapClass[st] || 'yellow';
            lbl.className = `px-3 py-1 bg-${color}-100 text-${color}-700 text-xs font-bold rounded-full border border-${color}-200`;
        }

        function renderGrid(grid) {
            const el = document.getElementById('calendar-grid');
            el.innerHTML='';
            const dates = Object.keys(grid).sort();
            if(dates.length===0) return;
            const startDay = new Date(dates[0]+'T12:00:00').getDay();
            for(let i=0; i<startDay; i++) el.innerHTML += `<div class="h-28 bg-gray-50 border-2 border-transparent opacity-20 hidden md:block"></div>`;
            
            dates.forEach(key => {
                const d = grid[key];
                const dayNum = new Date(key+'T12:00:00').getDate();
                let bg='bg-white border-gray-200 hover:border-blue-300', ind='', cnt='<span class="text-gray-300 text-xs">0h</span>';
                
                if(d.total>0 || d.entries.length>0) {
                    cnt=`<span class="font-bold text-gray-700 text-sm">${d.total}h</span>`;
                    const mapSt = {'draft':'gray','submitted':'blue','approved':'green','rejected':'red','closed':'slate','billed':'amber'};
                    const c = mapSt[d.status_approval] || 'gray';
                    if(d.status_approval !== 'draft') bg = `bg-${c}-50 border-${c}-200`;
                    
                    if(d.status_approval==='draft') bg='bg-white border-gray-300 border-dashed'; 
                    else if(d.status_approval==='rejected') ind='<i data-lucide="alert-circle" class="absolute top-2 right-2 w-4 h-4 text-red-600"></i>';
                    else if(d.status_approval==='submitted') ind='<div class="absolute top-2 right-2 w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>';
                    else if(d.status_approval==='approved') ind='<div class="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full"></div>';
                    else if(d.status_approval==='closed') ind='<i data-lucide="lock" class="absolute top-2 right-2 w-3 h-3 text-slate-500"></i>';
                    else if(d.status_approval==='billed') ind='<i data-lucide="check-circle-2" class="absolute top-2 right-2 w-3 h-3 text-amber-600"></i>';
                } else {
                    if(d.status_day==='holiday') cnt=`<span class="bg-rose-200 text-rose-700 text-[10px] px-2 py-0.5 rounded-full">${d.label}</span>`;
                    else if(d.status_day==='vacation') cnt=`<span class="bg-cyan-100 text-cyan-700 text-[10px] px-2 py-0.5 rounded-full">${d.label}</span>`;
                    else if(d.status_day==='weekend') bg='bg-gray-50 opacity-60';
                }
                el.innerHTML += `<div onclick="openDayPanel('${key}')" class="relative h-28 rounded-xl border-2 p-4 cursor-pointer transition-all flex flex-col justify-between group ${bg}">${ind}<span class="font-bold text-gray-400 group-hover:text-blue-600">${dayNum}</span><div class="mt-auto w-full">${cnt}</div></div>`;
            });
            lucide.createIcons();
        }

        async function openDayPanel(key) {
            const g = currentGridData[key];
            if(!g) return;
            currentOpenDayId = g.id;
            currentOpenDate = key; // Salva a data!

            isNonBusinessDay = (g.status_day==='weekend'||g.status_day==='holiday'||g.status_day==='vacation');
            
            document.getElementById('panel-weekday').innerText=new Date(key+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'long'});
            document.getElementById('panel-date').innerText=new Date(key+'T12:00:00').toLocaleDateString('pt-BR',{day:'numeric',month:'long'});
            
            const stMap={'draft':'Rascunho', 'submitted':'Lan√ßado', 'approved':'Aprovado', 'rejected':'Reprovado', 'closed':'Fechado', 'billed':'Faturado', 'empty':'Novo'};
            document.getElementById('footer-status').innerText = "Status: " + (stMap[g.status_approval] || 'Rascunho');
            resetActivitySearch();
            resetForm(); 
            projectAllocationMap = {}; 
            
            const allocL=document.getElementById('allocations-list');
            const projSel=document.getElementById('input-project');
            allocL.innerHTML='<span class="text-xs text-gray-400 p-2 animate-pulse">Carregando...</span>';
            projSel.innerHTML='<option value="" disabled selected>Carregando...</option>';
            
            const overlay=document.getElementById('slide-overlay');
            const panel=document.getElementById('day-panel');
            overlay.classList.remove('hidden'); setTimeout(()=>overlay.classList.remove('opacity-0'),10);
            panel.classList.remove('closed'); panel.classList.add('open');

            try {
                const res = await fetch(`/api/timesheet/day?date=${key}&diaPeriodoId=${g.id}`);
                const d = await res.json();
                
                dayProjects=d.allocations||[]; 
                dayActivities=d.activities||[]; 
                dayEntries=d.entries||[];
                
                allocL.innerHTML='';
                projSel.innerHTML='<option value="" disabled selected>Selecione...</option>';
                if(dayProjects.length>0) {
                    dayProjects.forEach(p => {
                        projectAllocationMap[p.id] = p.alocacaoId;
                        allocL.innerHTML+=`<div onclick="selectProjectFromCard('${p.id}')" class="snap-start bg-blue-50 border border-blue-100 hover:ring-blue-300 rounded-xl p-4 min-w-[220px] cursor-pointer transition-all relative group shadow-sm"><p class="text-xs text-blue-600 font-bold mb-1 uppercase tracking-wide">Projeto</p><p class="font-bold text-gray-800 text-sm truncate" title="${p.name}">${p.name}</p></div>`;
                        projSel.innerHTML+=`<option value="${p.id}">${p.name}</option>`;
                    });
                    if(dayProjects.length===1) { projSel.value=dayProjects[0].id; resetActivitySearch(); }
                } else allocL.innerHTML='<div class="text-xs text-gray-400 p-2 italic border border-dashed border-gray-200 rounded-lg w-full text-center">Sem aloca√ß√£o.</div>';
                
                renderEntriesList();
                validateRules('init'); 

                // L√≥gica de Bloqueio e Bot√£o Submeter
                const isLocked = d.isLocked;
                const hasDrafts = dayEntries.some(e => e.status === 'Rascunho');
                const btnSubmit = document.getElementById('btn-submit-day');
                const frm = document.getElementById('add-activity-container');
                const alert = document.getElementById('readonly-alert');

                if(isLocked) { 
                    frm.classList.add('opacity-50','pointer-events-none'); 
                    alert.classList.remove('hidden'); 
                    document.getElementById('readonly-reason').innerText=`Bloqueado (Enviado/Aprovado)`;
                    btnSubmit.style.display = 'none'; 
                } else { 
                    frm.classList.remove('opacity-50','pointer-events-none');
                    alert.classList.add('hidden');
                    btnSubmit.style.display = hasDrafts ? 'flex' : 'none'; 
                }

                const rej = document.getElementById('rejection-alert');
                if(dayEntries.some(e => e.status === 'Reprovado')) {
                     rej.classList.remove('hidden');
                     const rItem = dayEntries.find(e => e.status === 'Reprovado' && e.reason);
                     document.getElementById('rejection-reason').innerText = rItem ? rItem.reason : '';
                } else rej.classList.add('hidden');

            } catch(e) { console.error(e); allocL.innerHTML='Erro carregar'; }
            lucide.createIcons();
        }

        function renderEntriesList() {
            const entL = document.getElementById('entries-list');
            entL.innerHTML='';
            if(dayEntries.length>0) {
                dayEntries.forEach(e => {
                    const entryJson = JSON.stringify(e).replace(/"/g, '&quot;');
                    let brd='border-gray-200', msg='';
                    if(e.status==='Reprovado') { brd='border-red-200 bg-red-50'; msg=`<div class="text-xs text-red-600 mt-1"><i data-lucide="alert-circle" class="w-3 h-3 inline"></i> ${e.reason||'Sem motivo'}</div>`; }
                    const canEdit=['Rascunho','Reprovado'].includes(e.status);
                    
                    let badges = '';
                    if(e.hours > 0) badges += `<span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded text-[10px] font-bold">Normal: ${e.hours}h</span> `;
                    if(e.hoursExtra > 0) badges += `<span class="bg-green-50 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">Extra($): ${e.hoursExtra}h</span> `;
                    if(e.hoursBank > 0) badges += `<span class="bg-teal-50 text-teal-700 px-2 py-0.5 rounded text-[10px] font-bold">Banco(+): ${e.hoursBank}h</span> `;
                    if(e.hoursAbsence > 0) badges += `<span class="bg-orange-50 text-orange-700 px-2 py-0.5 rounded text-[10px] font-bold">Aus√™ncia: ${e.hoursAbsence}h</span> `;

                    // Visual do Status no card
                    let stColor = 'text-gray-400';
                    if(e.status === 'Lan√ßado') stColor = 'text-blue-500 font-bold';
                    if(e.status === 'Aprovado') stColor = 'text-green-500 font-bold';

                    entL.innerHTML+=`
                        <div onclick="editEntry(${canEdit ? entryJson : '{}'})" class="bg-white border ${brd} rounded-lg p-3 shadow-sm relative group hover:shadow-md transition-shadow ${canEdit ? 'cursor-pointer' : ''} pr-8">
                            <div class="flex justify-between items-start">
                                <div class="overflow-hidden">
                                    <p class="text-xs font-bold text-blue-600 truncate">${e.project}</p>
                                    <p class="text-sm text-gray-800 truncate">${e.activity}</p>
                                </div>
                                <span class="text-[10px] uppercase tracking-wide ${stColor}">${e.status}</span>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${badges}
                            </div>
                            ${msg}
                            ${canEdit ? `<button onclick="event.stopPropagation(); removeEntry('${e.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>`;
                });
                lucide.createIcons();
            } else entL.innerHTML='<p class="text-center text-gray-400 text-sm py-4">Sem lan√ßamentos.</p>';
        }

        // --- MANIPULA√á√ÉO DO FORMUL√ÅRIO (Mantido) ---
        function editEntry(entry) {
            if (!entry || !entry.id) return;
            document.getElementById('input-entry-id').value = entry.id;
            document.getElementById('form-title').innerText = 'Editar Atividade';
            document.getElementById('input-project').value = entry.projectId;
            document.getElementById('input-activity-search').value = entry.activity;
            document.getElementById('input-activity-id').value = entry.activityId;
            document.getElementById('input-normal').value = entry.hours;
            
            const extraField = document.getElementById('input-extra');
            const radios = document.getElementsByName('radio-extra');
            if (entry.hoursExtra > 0) { 
                extraField.value = entry.hoursExtra;
                radios.forEach(r => { if(r.value === 'Pagamento') r.checked = true; });
            } else if (entry.hoursBank > 0) { 
                extraField.value = entry.hoursBank;
                radios.forEach(r => { if(r.value === 'Banco') r.checked = true; });
            } else {
                extraField.value = 0;
                radios.forEach(r => { if(r.value === 'Banco') r.checked = true; });
            }

            document.getElementById('input-leave').value = entry.hoursAbsence;
            const selAbs = document.getElementById('select-absence-type');
            if (entry.hoursBank < 0) selAbs.value = 'Banco';
            else selAbs.value = 'Abonada'; 

            document.getElementById('input-reason').value = entry.justification || '';
            document.getElementById('btn-add-entry').innerText = 'Salvar Altera√ß√£o';
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('activity-dropdown').classList.add('hidden');
            validateRules('init');
        }

        function calculateDayTotals(excludeId = null) {
            let totalNormal = 0, totalExtra = 0, totalAbsence = 0, totalAll = 0;
            dayEntries.forEach(e => {
                if (e.id !== excludeId) {
                    totalNormal += e.hours;
                    totalExtra += (e.hoursExtra + (e.hoursBank > 0 ? e.hoursBank : 0));
                    totalAbsence += e.hoursAbsence;
                    totalAll += (e.hours + e.hoursExtra + Math.abs(e.hoursBank) + e.hoursAbsence);
                }
            });
            return { totalNormal, totalExtra, totalAbsence, totalAll };
        }

        function sanitizeField(el) {
            let val = parseFloat(el.value);
            if (isNaN(val) || val < 0) val = 0;
            el.value = val; 
            validateRules(el.id.replace('input-', '')); 
        }

        function validateRules(source) {
            const inputId = document.getElementById('input-entry-id').value; 
            const existing = calculateDayTotals(inputId); 
            const hN = document.getElementById('input-normal'), hE = document.getElementById('input-extra'), hL = document.getElementById('input-leave');
            const msgN = document.getElementById('msg-normal'), msgE = document.getElementById('msg-extra'), msgL = document.getElementById('msg-leave');
            
            msgN.classList.add('hidden'); msgE.classList.add('hidden'); msgL.classList.add('hidden');
            hN.disabled = false; hE.disabled = false; hL.disabled = false;

            let inN = parseFloat(hN.value) || 0, inE = parseFloat(hE.value) || 0, inL = parseFloat(hL.value) || 0;

            const totalSoFar = existing.totalAll + inN + inE + inL;
            if (totalSoFar > MAX_DAY_HOURS) {
                const cap = Math.max(0, MAX_DAY_HOURS - existing.totalAll - (inN+inE+inL) + (source==='normal'?inN : source==='extra'?inE : inL));
                if (source === 'normal') { inN = cap; hN.value = inN; }
                if (source === 'extra') { inE = cap; hE.value = inE; }
                if (source === 'leave') { inL = cap; hL.value = inL; }
            }

            if (isNonBusinessDay) {
                hN.disabled = true; hN.value = 0; inN = 0;
                hL.disabled = true; hL.value = 0; inL = 0;
                msgN.innerText = "Dia n√£o √∫til"; msgN.classList.remove('hidden');
                msgL.innerText = "Dia n√£o √∫til"; msgL.classList.remove('hidden');
            } else {
                const currentAbsence = existing.totalAbsence + inL;
                if (currentAbsence >= DAILY_CONTRACT) {
                    hN.disabled = true; hN.value = 0; inN = 0;
                    msgN.innerText = "Contrato preenchido"; msgN.classList.remove('hidden');
                } else {
                    const maxN = Math.max(0, DAILY_CONTRACT - currentAbsence - existing.totalNormal);
                    if (inN > maxN) { inN = maxN; hN.value = inN; msgN.innerText = `M√°x: ${maxN}h`; msgN.classList.remove('hidden'); }
                }
                const currentNormal = existing.totalNormal + inN;
                if (currentNormal >= DAILY_CONTRACT) {
                    hL.disabled = true; hL.value = 0; inL = 0;
                    msgL.innerText = "Contrato preenchido"; msgL.classList.remove('hidden');
                } else {
                    const maxL = Math.max(0, DAILY_CONTRACT - currentNormal - existing.totalAbsence);
                    if (inL > maxL) { inL = maxL; hL.value = inL; msgL.innerText = `M√°x: ${maxL}h`; msgL.classList.remove('hidden'); }
                }
                const effective = (existing.totalNormal + inN) + (existing.totalAbsence + inL);
                if (effective < DAILY_CONTRACT) {
                    hE.disabled = true; hE.value = 0; inE = 0;
                    msgE.innerText = "Complete as 8h"; msgE.classList.remove('hidden');
                }
            }

            const boxEx=document.getElementById('options-extra'), boxLe=document.getElementById('options-absence'), reqJ=document.getElementById('req-justification');
            if(inE > 0) { boxEx.classList.remove('hidden'); reqJ.classList.remove('hidden'); } else boxEx.classList.add('hidden');
            if(inL > 0) { boxLe.classList.remove('hidden'); reqJ.classList.remove('hidden'); } else boxLe.classList.add('hidden');
            if(inE===0 && inL===0) reqJ.classList.add('hidden');

            updateRealTimeFooter(existing, inN, inE, inL);
        }

        function updateRealTimeFooter(existing, inN, inE, inL) {
            const finalNormal = existing.totalNormal + inN;
            const finalAbsence = existing.totalAbsence + inL;
            const finalExtra = existing.totalExtra + inE;
            const grandTotal = finalNormal + finalAbsence + finalExtra;
            let balance = isNonBusinessDay ? grandTotal : grandTotal - DAILY_CONTRACT;

            document.getElementById('footer-normal').innerText = finalNormal.toFixed(1) + 'h';
            document.getElementById('footer-absence').innerText = finalAbsence.toFixed(1) + 'h';
            document.getElementById('footer-extra').innerText = finalExtra.toFixed(1) + 'h';
            const balEl = document.getElementById('footer-balance');
            const sign = balance > 0 ? '+' : '';
            balEl.innerText = `${sign}${balance.toFixed(1)}h`;
            if(balance > 0) balEl.className = "text-2xl font-extrabold text-purple-600";
            else if(balance < 0) balEl.className = "text-2xl font-extrabold text-red-400";
            else balEl.className = "text-2xl font-extrabold text-gray-400";
        }
        
        function resetForm() {
            document.getElementById('input-entry-id').value = '';
            document.getElementById('form-title').innerText = 'Nova Atividade';
            document.getElementById('input-normal').value = 0;
            document.getElementById('input-extra').value = 0;
            document.getElementById('input-leave').value = 0;
            document.getElementById('input-reason').value = '';
            resetActivitySearch();
            document.getElementById('btn-add-entry').innerText = 'Adicionar';
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            validateRules('init');
        }

        function resetActivitySearch() { document.getElementById('input-activity-search').value=''; document.getElementById('input-activity-id').value=''; document.getElementById('activity-dropdown').classList.add('hidden'); document.getElementById('btn-clear-activity').classList.add('hidden'); }
        function clearActivity(){ resetActivitySearch(); }
        function filterActivities() {
            const pId=document.getElementById('input-project').value; const term=document.getElementById('input-activity-search').value.toLowerCase().trim(); const drp=document.getElementById('activity-dropdown'); const clr=document.getElementById('btn-clear-activity'); document.getElementById('input-activity-id').value=''; if(!pId) return; if(term.length>0) clr.classList.remove('hidden'); else clr.classList.add('hidden');
            const matches=dayActivities.filter(a=>String(a.projectId)===String(pId)&&a.name.toLowerCase().includes(term));
            drp.innerHTML=''; let exact=false;
            matches.forEach(a=>{ if(a.name.toLowerCase()===term) exact=true; drp.innerHTML+=`<li onclick="selectExistingActivity('${a.id}','${a.name}')" class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm text-gray-700 border-b border-gray-100 last:border-0 block">${a.name}</li>`; });
            if(term.length>0 && !exact) drp.innerHTML+=`<li onclick="selectNewActivity()" class="px-4 py-3 bg-blue-50 hover:bg-blue-100 cursor-pointer text-sm text-blue-700 font-bold flex items-center gap-2 border-t border-blue-100 block"><i data-lucide="plus" class="w-4 h-4"></i> Criar: "${document.getElementById('input-activity-search').value}"</li>`;
            if(matches.length>0 || (term.length>0 && !exact)) { drp.classList.remove('hidden'); lucide.createIcons(); } else drp.classList.add('hidden');
        }
        function selectExistingActivity(id,name) { document.getElementById('input-activity-search').value=name; document.getElementById('input-activity-id').value=id; document.getElementById('activity-dropdown').classList.add('hidden'); }
        function selectNewActivity() { document.getElementById('input-activity-id').value='NEW'; document.getElementById('activity-dropdown').classList.add('hidden'); }
        document.addEventListener('click', function(e) { const inp=document.getElementById('input-activity-search'); const drp=document.getElementById('activity-dropdown'); const clr=document.getElementById('btn-clear-activity'); const hid=document.getElementById('input-activity-id'); if(!inp.contains(e.target)&&!drp.contains(e.target)&&!clr.contains(e.target)) { drp.classList.add('hidden'); if(hid.value==='') { inp.value=''; clr.classList.add('hidden'); } } });
        document.addEventListener('keydown', function(e) { if(e.key==='Escape') { const drp=document.getElementById('activity-dropdown'); if(!drp.classList.contains('hidden')) { drp.classList.add('hidden'); document.getElementById('input-activity-search').blur(); } else if(!document.getElementById('slide-overlay').classList.contains('hidden')) closeDayPanel(); } });
        function closeDayPanel() { document.getElementById('day-panel').classList.remove('open'); document.getElementById('day-panel').classList.add('closed'); const ov=document.getElementById('slide-overlay'); ov.classList.add('opacity-0'); setTimeout(()=>ov.classList.add('hidden'),300); }
        function selectProjectFromCard(id) { document.getElementById('input-project').value=id; resetActivitySearch(); }

        // --- SUBMIT DAY ---
        async function submitDay() {
            if(!confirm("Enviar lan√ßamentos deste dia para aprova√ß√£o?")) return;
            const btn = document.getElementById('btn-submit-day'); 
            btn.disabled = true; btn.innerHTML = "<span>‚è≥</span> Enviando...";
            
            try {
                // ENVIA DATA (string)
                const res = await fetch('/api/timesheet/submit-day', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ date: currentOpenDate }) 
                });
                const d = await res.json();
                if (d.success) { 
                    alert(d.message); 
                    closeDayPanel(); 
                    loadCalendar(currentPeriods[currentPeriodIndex].Id); 
                } else { 
                    alert('Erro: ' + d.message); 
                }
            } catch (e) { alert('Erro de conex√£o.'); } 
            finally { btn.disabled = false; btn.innerHTML = "<span>üöÄ</span> Lan√ßar Dia"; }
        }

        async function submitPeriod() {
            if(!currentPeriods[currentPeriodIndex]) return;
            const pId = currentPeriods[currentPeriodIndex].Id;
            if(!confirm("Enviar FOLHA DO M√äS inteira para aprova√ß√£o?")) return;
            try {
                const res = await fetch('/api/timesheet/submit-period', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ periodId: pId }) });
                const d = await res.json();
                if (d.success) { alert(d.message); loadCalendar(pId); } else { alert('Erro: ' + d.message); }
            } catch (e) { alert('Erro de conex√£o.'); }
        }

        async function addEntry() {
            // ... (Mesma l√≥gica de addEntry) ...
            // Importante passar 'date: currentOpenDate' no body
            const entryId = document.getElementById('input-entry-id').value; 
            const pId = document.getElementById('input-project').value;
            const alocacaoId = projectAllocationMap[pId]; 
            let rawId=document.getElementById('input-activity-id').value; 
            const actName=document.getElementById('input-activity-search').value; 
            const actId=(rawId==='NEW')?'':rawId;
            const hN=parseFloat(document.getElementById('input-normal').value)||0; 
            const hE=parseFloat(document.getElementById('input-extra').value)||0; 
            const hA=parseFloat(document.getElementById('input-leave').value)||0; 
            const reason=document.getElementById('input-reason').value.trim();

            if(!pId) return alert("Selecione projeto.");
            if(!actName) return alert("Informe atividade."); 
            if((hN+hE+hA)===0) return alert("Informe horas."); 
            if((hE>0||hA>0)&&reason.length<5) return alert("Justificativa obrigat√≥ria.");
            
            let exType=''; if(hE>0) document.getElementsByName('radio-extra').forEach(r=>{if(r.checked) exType=r.value});
            let abType=''; if(hA>0) abType=document.getElementById('select-absence-type').value;

            const btn=document.getElementById('btn-add-entry'); 
            const originalText = btn.innerText; btn.innerText='Salvando...'; btn.disabled=true;
            
            try {
                const res = await fetch('/api/timesheet/entry', { 
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({ entryId: entryId || null, diaPeriodoId: currentOpenDayId, projectId: pId, alocacaoId: alocacaoId, activityId: actId, activityName: actName, hoursNormal: hN, hoursExtra: hE, hoursAbsence: hA, reason: reason, extraType: exType, absenceType: abType, date: currentOpenDate }) 
                });
                const d = await res.json();
                if(d.success) {
                    loadCalendar(currentPeriods[currentPeriodIndex].Id).then(() => { 
                        return fetch(`/api/timesheet/day?date=${currentOpenDate}&diaPeriodoId=${currentOpenDayId}`); 
                    }).then(r=>r.json()).then(newData => { 
                        dayEntries=newData.entries; renderEntriesList(); validateRules('init'); resetForm(); 
                        const hasDrafts = dayEntries.some(e => e.status === 'Rascunho');
                        document.getElementById('btn-submit-day').style.display = hasDrafts ? 'flex' : 'none';
                    });
                } else alert('Erro: '+d.message);
            } catch(e){ console.error(e); } finally { btn.innerText=originalText; btn.disabled=false; }
        }

        async function removeEntry(id) {
            if(!confirm("Excluir lan√ßamento?")) return;
            try {
                const res = await fetch(`/api/timesheet/entry/${id}`, {method:'DELETE'});
                const d = await res.json();
                if(d.success) {
                     loadCalendar(currentPeriods[currentPeriodIndex].Id).then(() => { 
                         return fetch(`/api/timesheet/day?date=${currentOpenDate}&diaPeriodoId=${currentOpenDayId}`); 
                     }).then(r=>r.json()).then(newData => { 
                         dayEntries=newData.entries; renderEntriesList(); validateRules('init'); resetForm(); 
                         const hasDrafts = dayEntries.some(e => e.status === 'Rascunho');
                         document.getElementById('btn-submit-day').style.display = hasDrafts ? 'flex' : 'none';
                     });
                } else alert('Erro: '+d.message);
            } catch(e) { alert('Erro t√©cnico'); }
        }
    </script>
</body>
</html>