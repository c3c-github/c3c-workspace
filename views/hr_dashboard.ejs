<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Ponto (RH) - C3C Workplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Montserrat', 'sans-serif'] } } } }</script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-[#F8FAFC]">

    <div id="mobile-overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>
    <%- include('partials/sidebar') %>

    <main class="flex-1 flex flex-col md:ml-64 relative w-full transition-all duration-300">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleMenu()" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">Gestão de Ponto <span class="hidden md:inline-flex bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> RH</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <select id="period-selector" onchange="triggerDataLoad(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 cursor-pointer outline-none min-w-[150px]"><option>Carregando...</option></select>
                <button onclick="triggerDataLoad(document.getElementById('period-selector').value)" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg shadow-sm transition-colors" title="Atualizar"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i data-lucide="users" class="w-6 h-6"></i></div><div><p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Colaboradores</p><p class="text-2xl font-bold text-gray-900" id="kpi-total">--</p></div></div>
                <div class="bg-white p-5 rounded-xl border border-red-100 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div><div><p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Risco Burnout</p><p class="text-2xl font-bold text-gray-900" id="kpi-burnout">--</p></div></div>
                <div class="bg-white p-5 rounded-xl border border-yellow-100 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center"><i data-lucide="coffee" class="w-6 h-6"></i></div><div><p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Ociosidade</p><p class="text-2xl font-bold text-gray-900" id="kpi-ociosos">--</p></div></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col">
                <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 class="text-lg font-bold text-gray-900">Saúde da Alocação & Folha</h2>
                    <div class="relative w-full sm:w-auto"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i><input type="text" id="search-input" onkeyup="filterTable()" placeholder="Buscar colaborador..." class="pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 whitespace-nowrap">Colaborador</th>
                                <th class="px-6 py-4 whitespace-nowrap text-center">Projetos</th>
                                <th class="px-6 py-4 whitespace-nowrap min-w-[200px]">Carga vs Realizado</th>
                                <th class="px-6 py-4 whitespace-nowrap text-center">Status</th>
                                <th class="px-6 py-4 whitespace-nowrap text-right">Ação RH</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="hr-table-body">
                            <tr><td colspan="5" class="text-center py-10 text-gray-400">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="logs-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="bg-gray-900 text-white rounded-t-xl shrink-0 flex flex-col">
                <div class="p-6 pb-4 flex justify-between items-start">
                    <div><h3 class="text-xl font-bold" id="modal-name">Colaborador</h3><p class="text-gray-400 text-xs mt-0.5 uppercase tracking-wider">Fechamento de Período</p></div>
                    <button onclick="closeModal()" class="bg-gray-800 hover:bg-gray-700 p-2 rounded-lg text-gray-300 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="px-6 pb-6 grid grid-cols-2 md:grid-cols-7 gap-4 text-center md:text-left">
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-gray-300" id="modal-normal">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Normais</span></div>
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-green-400" id="modal-extra">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Extra ($)</span></div>
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-indigo-400" id="modal-banco">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Banco</span></div>
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-orange-400" id="modal-ausencia">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Ausências</span></div>
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-white" id="modal-total">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Realizado</span></div>
                    <div class="border-r border-gray-800 pr-2"><span class="block text-xl font-bold text-blue-200" id="modal-meta">--</span><span class="text-[10px] text-blue-400 uppercase font-bold">Meta</span></div>
                    <div><span class="block text-xl font-bold" id="modal-saldo">--</span><span class="text-[10px] text-gray-500 uppercase font-bold">Saldo</span></div>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 bg-white">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold sticky top-0 shadow-sm z-10 border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-3">Data</th>
                            <th class="px-6 py-3">Serviço</th> <th class="px-6 py-3">Atividade / Justificativa</th>
                            <th class="px-6 py-3 text-right text-blue-600 border-l border-white">Normal</th>
                            <th class="px-6 py-3 text-right text-green-600 border-l border-white">Extra</th>
                            <th class="px-6 py-3 text-right text-indigo-600 border-l border-white">Banco</th>
                            <th class="px-6 py-3 text-right text-orange-600 border-l border-white">Ausência</th>
                            <th class="px-6 py-3 text-center border-l border-white">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white" id="modal-logs-body"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white rounded-b-xl flex justify-end shrink-0"><button onclick="closeModal()" class="px-4 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Fechar</button></div>
        </div>
    </div>

    <div id="modal-reject" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-bold text-red-600 mb-2">Reprovar Folha</h3>
                <p class="text-sm text-gray-600 mb-4">Motivo para <strong id="reject-person-name"></strong>:</p>
                <input type="hidden" id="reject-person-id">
                <textarea id="reject-reason" rows="3" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-red-500 outline-none mb-4" placeholder="Justificativa..."></textarea>
                <div class="flex justify-end gap-3"><button onclick="document.getElementById('modal-reject').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded">Cancelar</button><button onclick="confirmReject()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded shadow-sm">Confirmar</button></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_URL = '/api';

        document.addEventListener('DOMContentLoaded', () => { loadPeriods(); });
        function toggleMenu() { const s=document.getElementById('sidebar'); const o=document.getElementById('mobile-overlay'); if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('hidden');setTimeout(()=>o.classList.remove('opacity-0'),10);}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0');setTimeout(()=>o.classList.add('hidden'),300);} }

        async function loadPeriods() {
            try {
                const res = await fetch(`${API_URL}/periods`);
                if(res.status===401) window.location.href='/';
                const periods = await res.json();
                const sel = document.getElementById('period-selector');
                sel.innerHTML = '';
                if(periods.length===0){ sel.innerHTML='<option>Sem contratos</option>'; return; }
                periods.forEach((p,i) => {
                    const opt=document.createElement('option');
                    opt.value=JSON.stringify({start:p.DataInicio__c, end:p.DataFim__c}); opt.text=p.Name; if(i===0)opt.selected=true;
                    sel.appendChild(opt);
                });
                if(sel.options.length>0) triggerDataLoad(sel.value);
            } catch(e) { console.error(e); }
        }

        function triggerDataLoad(v) { if(!v)return; const d=JSON.parse(v); loadTableData(d.start, d.end); }

        async function loadTableData(start, end) {
            const tbody = document.getElementById('hr-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10"><div class="animate-pulse text-blue-600 font-bold">Carregando dados...</div></td></tr>';
            try {
                const res = await fetch(`${API_URL}/hr/employees?inicio=${start}&fim=${end}`);
                const r = await res.json();
                
                if(r.kpis) {
                    document.getElementById('kpi-total').innerText = r.kpis.total;
                    document.getElementById('kpi-burnout').innerText = r.kpis.burnout;
                    document.getElementById('kpi-ociosos').innerText = r.kpis.ociosos;
                }
                const data = r.data;
                tbody.innerHTML = '';
                if(!data || data.length===0) { tbody.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-400">Nenhum dado.</td></tr>'; return; }

                data.forEach(p => {
                    const pct = p.contract>0 ? (p.total/p.contract)*100 : 0;
                    let barColor = p.statusKPI==='danger'?'bg-red-500':(p.statusKPI==='risk'?'bg-yellow-500':'bg-green-500');
                    let stClass = 'bg-gray-100 text-gray-600';
                    if(p.statusUI==='Pronto para Fechamento') stClass='bg-green-100 text-green-800 font-bold';
                    else if(p.statusUI.includes('Faturado')) stClass='bg-blue-100 text-blue-800 font-bold';
                    
                    let actHtml = `<div class="flex items-center justify-end gap-2"><button onclick="openModal('${p.id}','${p.name}')" class="p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button></div>`;
                    if(p.canAction) {
                        actHtml = `<div class="flex items-center justify-end gap-2">
                            <button onclick="openModal('${p.id}','${p.name}')" class="p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-lg"><i data-lucide="eye" class="w-4 h-4"></i></button>
                            <button onclick="openRejectModal('${p.id}','${p.name}')" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold rounded">Reprovar</button>
                            <button onclick="performAction('${p.id}','${p.name}','close')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold rounded shadow-sm">Fechar</button>
                        </div>`;
                    }

                    tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                        <td class="px-6 py-4"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-xs font-bold text-blue-600">${p.name.charAt(0)}</div><div><p class="font-bold text-gray-900">${p.name}</p><p class="text-xs text-gray-400">${p.role}</p></div></div></td>
                        <td class="px-6 py-4 text-center"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${p.projects.length} Proj.</span></td>
                        <td class="px-6 py-4 align-middle"><div class="flex justify-between text-xs font-bold mb-1"><span class="text-gray-700">${p.total.toFixed(1)}h</span><span class="text-gray-400">Meta: ${p.contract}h</span></div><div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden"><div class="${barColor} h-1.5 rounded-full" style="width:${Math.min(pct,100)}%"></div></div></td>
                        <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded-full text-xs ${stClass}">${p.statusUI}</span></td>
                        <td class="px-6 py-4 text-right">${actHtml}</td>
                    </tr>`;
                });
                lucide.createIcons();
            } catch(e){ console.error(e); tbody.innerHTML='<tr><td colspan="5" class="text-center text-red-500 py-10">Erro.</td></tr>'; }
        }

        function filterTable() {
            const v = document.getElementById("search-input").value.toUpperCase();
            const tr = document.getElementById("hr-table-body").getElementsByTagName("tr");
            for(let i=0;i<tr.length;i++){ const td=tr[i].getElementsByTagName("td")[0]; if(td) tr[i].style.display=td.textContent.toUpperCase().indexOf(v)>-1?"":"none"; }
        }

        async function openModal(id, name) {
            const m = document.getElementById('logs-modal');
            const tb = document.getElementById('modal-logs-body');
            document.getElementById('modal-name').innerText = name;
            ['modal-normal','modal-extra','modal-banco','modal-ausencia','modal-total','modal-meta','modal-saldo'].forEach(e=>document.getElementById(e).innerText='...');
            tb.innerHTML='<tr><td colspan="8" class="text-center py-8">Carregando...</td></tr>';
            m.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('opacity-0');m.querySelector('div').classList.remove('scale-95');},10);

            const dates = JSON.parse(document.getElementById('period-selector').value);
            try {
                const res = await fetch(`${API_URL}/hr/employees/${id}/details?inicio=${dates.start}&fim=${dates.end}`);
                const d = await res.json();
                const s = d.summary;

                document.getElementById('modal-normal').innerText = s.normal.toFixed(1)+'h';
                document.getElementById('modal-extra').innerText = s.extra.toFixed(1)+'h';
                const b = document.getElementById('modal-banco'); b.innerText=(s.banco>0?'+':'')+s.banco.toFixed(1)+'h';
                b.className = s.banco>0 ? "block text-xl font-bold text-indigo-400":(s.banco<0?"block text-xl font-bold text-yellow-400":"block text-xl font-bold text-gray-500");
                document.getElementById('modal-ausencia').innerText = s.ausencia.toFixed(1)+'h';
                document.getElementById('modal-total').innerText = s.totalRealizado.toFixed(1)+'h';
                document.getElementById('modal-meta').innerText = s.contract.toFixed(1)+'h';
                
                const saldo = s.totalRealizado - s.contract;
                const salEl = document.getElementById('modal-saldo');
                salEl.innerText = (saldo>0?'+':'')+saldo.toFixed(1)+'h';
                salEl.className = saldo>0 ? "block text-xl font-bold text-green-400" : (saldo<0?"block text-xl font-bold text-red-400":"block text-xl font-bold text-gray-400");

                tb.innerHTML = '';
                if(d.logs.length===0){ tb.innerHTML='<tr><td colspan="8" class="text-center py-8 text-gray-400">Sem registros.</td></tr>'; return; }

                d.logs.forEach(l => {
                    // FILTRO DE ZEROS VISUAL PARA GARANTIR LIMPEZA
                    const totalLinha = l.normal + l.extraPgto + Math.abs(l.banco) + l.ausencia;
                    if(totalLinha === 0) return;

                    const date = new Date(l.date+'T12:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', weekday:'short'});
                    const just = l.justification ? `<br><span class="text-[10px] text-gray-400 italic">"${l.justification}"</span>`:'';
                    
                    tb.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-50">
                        <td class="px-6 py-3 text-xs text-gray-500 uppercase font-bold">${date}</td>
                        <td class="px-6 py-3 text-xs font-bold text-blue-800">${l.project}</td> <td class="px-6 py-3 text-xs font-medium text-gray-900">${l.activity}${just}</td>
                        <td class="px-6 py-3 text-xs text-right text-blue-600 bg-blue-50/20 font-bold">${l.normal>0?l.normal.toFixed(1):'-'}</td>
                        <td class="px-6 py-3 text-xs text-right text-green-600 bg-green-50/20 font-bold">${l.extraPgto>0?l.extraPgto.toFixed(1):'-'}</td>
                        <td class="px-6 py-3 text-xs text-right text-indigo-600 bg-indigo-50/20 font-bold">${l.banco!==0?l.banco.toFixed(1):'-'}</td>
                        <td class="px-6 py-3 text-xs text-right text-orange-600 bg-orange-50/20 font-bold">${l.ausencia>0?l.ausencia.toFixed(1):'-'}</td>
                        <td class="px-6 py-3 text-xs text-center text-gray-400">${l.status}</td>
                    </tr>`;
                });
            } catch(e) { console.error(e); tb.innerHTML='<tr><td colspan="8" class="text-center text-red-500 py-8">Erro.</td></tr>'; }
        }

        function closeModal() { const m=document.getElementById('logs-modal'); m.classList.add('opacity-0'); m.querySelector('div').classList.add('scale-95'); setTimeout(()=>m.classList.add('hidden'),300); }

        function openRejectModal(id,name) { document.getElementById('reject-person-id').value=id; document.getElementById('reject-person-name').innerText=name; document.getElementById('reject-reason').value=''; document.getElementById('modal-reject').classList.remove('hidden'); }
        function confirmReject() { const id=document.getElementById('reject-person-id').value; const name=document.getElementById('reject-person-name').innerText; const r=document.getElementById('reject-reason').value.trim(); if(!r){alert("Motivo obrigatório");return;} performAction(id,name,'reject',r); document.getElementById('modal-reject').classList.add('hidden'); }

        async function performAction(pid, pname, type, reason=null) {
            if(type==='close' && !confirm(`Confirma o FECHAMENTO de ${pname}?`)) return;
            const dates=JSON.parse(document.getElementById('period-selector').value);
            try {
                const res = await fetch(`${API_URL}/hr/action`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({personId:pid, action:type, inicio:dates.start, fim:dates.end, motivo:reason})});
                const r = await res.json();
                if(r.success) { alert(r.message); loadTableData(dates.start, dates.end); } else alert('Erro: '+r.message);
            } catch(e){ alert('Erro de conexão'); }
        }
    </script>
</body>
</html>