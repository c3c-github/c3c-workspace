<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Serviços - C3C Workplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Montserrat', 'sans-serif'] }, colors: { c3c: { blue: '#2978FF', bg: '#F8FAFC' } } } } }
    </script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); z-index: 50; }
        .modal-tab-active { border-bottom: 2px solid #2978FF; color: #2978FF; font-weight: 700; background-color: #F8FAFC; }
        .modal-tab-inactive { border-bottom: 2px solid transparent; color: #6B7280; }
        .modal-tab-inactive:hover { color: #1a1a1a; background-color: #F9FAFB; }
        .table-dense th, .table-dense td { padding: 6px 8px; font-size: 11px; vertical-align: middle; }
        .input-inline { background: transparent; border: 1px solid transparent; width: 100%; border-radius: 4px; padding: 2px; }
        .input-inline:hover { border-color: #E5E7EB; background: white; }
        .input-inline:focus { border-color: #2978FF; background: white; outline: none; box-shadow: 0 0 0 2px rgba(41, 120, 255, 0.1); }
        .readonly-field { background-color: #F3F4F6; color: #6B7280; cursor: not-allowed; }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-c3c-bg">
    <%- include('partials/sidebar', { user: user, page: page }) %>
    <main class="flex-1 flex flex-col md:ml-64 relative w-full overflow-hidden">
        <header class="h-20 bg-white border-b border-gray-200 flex items-center justify-between px-8 shrink-0 z-10">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="layers" class="w-6 h-6 text-indigo-600"></i> Portfólio de Serviços</h1>
            <div class="flex items-center gap-4">
                <input type="text" id="search-input" placeholder="Buscar serviço ou cliente..." class="w-64 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" onkeyup="filterServices()">
                <div class="h-8 w-px bg-gray-200"></div>
                <select id="status-filter" onchange="filterServices()" class="text-sm font-bold text-gray-700 bg-transparent outline-none cursor-pointer">
                    <option value="all">Todos</option>
                    <option value="active" selected>Ativos</option>
                    <option value="inactive">Inativos</option>
                </select>
                <button onclick="openServiceModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-2.5 rounded-lg shadow-md flex items-center gap-2 transition-transform active:scale-95"><i data-lucide="plus" class="w-4 h-4"></i> Novo</button>
            </div>
        </header>
        <div class="flex-1 overflow-y-auto p-8 fade-in bg-c3c-bg">
            <div class="grid grid-cols-1 gap-6" id="services-grid"></div>
            <div id="no-results" class="hidden flex-col items-center justify-center py-20 text-center"><i data-lucide="search-x" class="w-8 h-8 text-gray-400 mb-2"></i><h3 class="font-bold text-gray-600">Nada encontrado</h3></div>
        </div>
    </main>

    <!-- MEGA MODAL -->
    <div id="service-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-[95rem] h-[95vh] flex flex-col transform scale-95 transition-transform duration-300 relative">
            
            <!-- LOADER OVERLAY -->
            <div id="modal-loader" class="absolute inset-0 bg-white/80 z-[100] flex items-center justify-center hidden rounded-xl">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p class="text-sm font-bold text-indigo-600 animate-pulse">Processando...</p>
                </div>
            </div>

            <div class="p-4 border-b border-gray-100 bg-gray-50 rounded-t-xl shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-gray-900 text-lg" id="modal-svc-title">Novo Serviço</h3>
                        <span id="badge-status" class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded border border-green-200 font-bold uppercase">Novo</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="saveService()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg shadow-md flex items-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="check" class="w-3.5 h-3.5"></i> Salvar
                        </button>
                        <button onclick="closeModal('service-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white border border-gray-200 p-3 rounded-lg shadow-sm flex justify-between items-center"><div><p class="text-[10px] font-bold text-gray-400 uppercase">Vendido (Baseline)</p><p class="text-lg font-bold text-gray-800" id="card-prop-rev">R$ 0,00</p></div><div class="text-right"><p class="text-[10px] font-bold text-gray-400">Margem</p><p class="text-sm font-bold text-blue-600" id="card-prop-margin">0%</p></div></div>
                    <div class="bg-white border border-gray-200 p-3 rounded-lg shadow-sm flex justify-between items-center"><div><p class="text-[10px] font-bold text-gray-400 uppercase">Previsto (Alocação)</p><p class="text-lg font-bold text-gray-800" id="card-fcst-rev">R$ 0,00</p></div><div class="text-right"><p class="text-[10px] font-bold text-gray-400">Margem</p><p class="text-sm font-bold text-indigo-600" id="card-fcst-margin">0%</p></div></div>
                    <div class="bg-white border border-gray-200 p-3 rounded-lg shadow-sm flex justify-between items-center"><div><p class="text-[10px] font-bold text-gray-400 uppercase">Realizado</p><p class="text-lg font-bold text-gray-800" id="card-act-rev">R$ 0,00</p></div><div class="text-right"><p class="text-[10px] font-bold text-gray-400">Margem</p><p class="text-sm font-bold text-green-600" id="card-act-margin">0%</p></div></div>
                </div>
            </div>
            <div class="flex border-b border-gray-200 bg-white shrink-0 px-6 overflow-x-auto">
                <button onclick="switchTab('general')" id="tab-general" class="modal-tab-active px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Visão Geral</button>
                <button onclick="switchTab('billing')" id="tab-billing" class="modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Faturamento</button>
                <button onclick="switchTab('commercial')" id="tab-commercial" class="modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Planejamento Comercial</button>
                <button onclick="switchTab('execution')" id="tab-execution" class="modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Previsão (Alocação)</button>
                <button onclick="switchTab('realized')" id="tab-realized" class="modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Execução (Real)</button>
                <button onclick="switchTab('financial')" id="tab-financial" class="modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap">Financeiro Detalhado</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-white text-sm">
                <!-- 1. GERAL -->
                <div id="view-general" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="font-bold text-gray-800 border-b border-gray-100 pb-2">Dados do Contrato</h4>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Nome do Serviço</label><input type="text" id="input-svc-name" class="w-full border border-gray-300 rounded p-2 focus:border-blue-500 outline-none"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Cliente (SF)</label><div class="relative"><input list="sf-accounts-list" id="input-sf-account" class="w-full border border-gray-300 rounded p-2 pr-8"><button onclick="document.getElementById('input-sf-account').value=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div><datalist id="sf-accounts-list"></datalist></div>
                                <div>
                                    <div class="flex items-center gap-1 mb-1">
                                        <label class="block text-xs font-bold text-gray-500">Cliente (Conta Azul)</label>
                                        <div class="group relative">
                                            <i data-lucide="help-circle" class="w-3.5 h-3.5 text-indigo-400 cursor-help"></i>
                                            <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block w-64 bg-gray-800 text-white text-[10px] p-2 rounded-lg shadow-2xl z-[110] leading-relaxed">
                                                <p class="font-bold border-b border-gray-600 mb-1 pb-1 text-indigo-300">Atenção!</p>
                                                Se o cliente não aparecer na lista, ele deve ser cadastrado no <b>ERP Conta Azul</b> pela equipe Comercial/Financeira antes de prosseguir.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="relative"><input list="ca-clients-list" id="input-ca-client" class="w-full border border-gray-300 rounded p-2 focus:border-blue-500 outline-none pr-8" placeholder="Vincular CNPJ..."><button onclick="document.getElementById('input-ca-client').value=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                                    <datalist id="ca-clients-list"></datalist>
                                </div>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label><select id="input-svc-type" class="w-full border border-gray-300 rounded p-2"><option>Suporte</option><option>Projeto</option><option>Alocação</option></select></div>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Data Início</label><input type="date" id="input-svc-start" class="w-full border border-gray-300 rounded p-2"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Data Fim Original</label><input type="date" id="input-svc-end-orig" class="w-full border border-gray-300 rounded p-2"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Data Fim (Real)</label><input type="date" id="input-svc-end-real" class="w-full border border-gray-300 rounded p-2"></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-bold text-gray-800 border-b border-gray-100 pb-2">Liderança</h4>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Líder de Projeto</label><div class="relative"><input list="people-list" id="input-lead-project" class="w-full border border-gray-300 rounded p-2 pr-8"><button onclick="document.getElementById('input-lead-project').value=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Coordenador</label><div class="relative"><input list="people-list" id="input-coordinator" class="w-full border border-gray-300 rounded p-2 pr-8"><button onclick="document.getElementById('input-coordinator').value=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Líder Técnico</label><div class="relative"><input list="people-list" id="input-tech-lead" class="w-full border border-gray-300 rounded p-2 pr-8"><button onclick="document.getElementById('input-tech-lead').value=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>
                            <datalist id="people-list"></datalist>
                        </div>
                    </div>
                    <div class="mt-8 border-t border-gray-100 pt-6">
                        <h4 class="font-bold text-gray-800 mb-4">Documentação</h4>
                        <div class="space-y-2">
                            <div id="docs-list-container" class="space-y-2 bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-xs text-gray-400 italic">Nenhum documento anexado.</div>
                            <div class="p-1 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
                                <button onclick="openUploadModal()" class="w-full bg-white border border-gray-200 text-gray-600 text-xs px-3 py-2 rounded font-bold hover:bg-gray-50 flex items-center justify-center gap-2 transition-colors">
                                    <i data-lucide="upload-cloud" class="w-3.5 h-3.5"></i> Anexar Documento
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 2. FATURAMENTO -->
                <div id="view-billing" class="hidden space-y-6">
                    <!-- SEÇÃO 1: GESTÃO DE VENDAS (CONTAS A RECEBER) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="dollar-sign" class="w-4 h-4 text-green-600"></i> 
                                    Vendas Vinculadas (Conta Azul)
                                </h4>
                                <p class="text-[10px] text-gray-500 mt-1">Selecione as vendas do ERP que compõem este contrato.</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto border border-gray-100 rounded-lg">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-50 font-bold text-gray-600 uppercase text-[10px]">
                                    <tr>
                                        <th class="px-4 py-3 w-64">Buscar Venda (Nº / Valor)</th>
                                        <th class="px-4 py-3 text-center w-32">Data Venda</th>
                                        <th class="px-4 py-3 text-center w-32">Status</th>
                                        <th class="px-4 py-3 text-right w-32">Valor Total</th>
                                        <th class="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="linked-sales-rows" class="divide-y divide-gray-100 bg-white"></tbody>
                                <tfoot class="bg-gray-50 font-bold text-gray-700 border-t border-gray-200">
                                    <tr>
                                        <td colspan="3" class="px-4 py-3 text-right uppercase text-[10px]">Total Vinculado:</td>
                                        <td class="px-4 py-3 text-right text-green-700" id="total-linked-sales">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="p-2 bg-gray-50 border-t border-gray-200">
                                <button onclick="addSalesRow()" class="w-full bg-white border border-gray-300 text-gray-700 text-xs px-3 py-2 rounded font-bold hover:bg-gray-100 flex items-center justify-center gap-2">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Adicionar Venda
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Datalist para Vendas (Preenchido via JS) -->
                    <datalist id="available-sales-list"></datalist>

                    <!-- SEÇÃO 2: PARCELAS -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="calendar-check" class="w-4 h-4 text-indigo-600"></i> 
                                    Previsão de Parcelas (ERP)
                                </h4>
                                <p class="text-[10px] text-gray-500 mt-1">Parcelas geradas automaticamente a partir das vendas vinculadas.</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto border border-gray-100 rounded-lg">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-50 font-bold text-gray-600 uppercase text-[10px]">
                                    <tr>
                                        <th class="px-4 py-3 w-10">#</th>
                                        <th class="px-4 py-3">Descrição / Venda</th>
                                        <th class="px-4 py-3 text-center">Competência</th>
                                        <th class="px-4 py-3 text-center">Vencimento</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                        <th class="px-4 py-3 text-right">Valor</th>
                                        <th class="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="svc-billing-list" class="divide-y divide-gray-100 bg-white">
                                    <tr><td colspan="7" class="px-4 py-6 text-center text-gray-400 italic">Nenhuma parcela disponível. Vincule vendas para gerar.</td></tr>
                                </tbody>
                                <tfoot class="bg-gray-50 font-bold text-gray-700 border-t border-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-4 py-3 text-right uppercase text-[10px]">Total Parcelas:</td>
                                        <td class="px-4 py-3 text-right text-indigo-700" id="total-installments">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- OUTRAS ABAS (Mantidas) -->
                <div id="view-commercial" class="hidden space-y-6">
                    <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg">
                        <div><h4 class="text-sm font-bold text-blue-800">Orçamento (Baseline)</h4><p class="text-[10px] text-blue-600 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Cálculo considera dias úteis e feriados.</p></div>
                        <div class="flex items-center gap-2"><label class="text-[10px] font-bold text-blue-700 uppercase">Tabela:</label><select id="select-pricebook" onchange="onPricebookChange()" class="text-xs border border-blue-200 rounded p-1 bg-white"><option>Carregando...</option></select></div>
                    </div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg mt-4"><table class="w-full text-left table-dense"><thead class="bg-gray-100 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr><th class="w-48">Produto / Perfil</th><th class="text-right w-24">Taxa Venda</th><th class="text-right w-24">Custo Base</th><th class="text-center w-24">Início</th><th class="text-center w-24">Fim</th><th class="text-center w-12">Dias</th><th class="text-center w-12">%</th><th class="text-right w-20">Hrs Totais</th><th class="text-right w-28 bg-green-50">Receita Total</th><th class="text-right w-28">Custo Total</th><th class="text-right w-16">Margem</th><th class="w-8"></th></tr></thead><tbody id="commercial-rows" class="divide-y divide-gray-100 bg-white"></tbody><tfoot class="bg-gray-50 font-bold text-gray-700 border-t border-gray-200"><tr><td colspan="7" class="text-right uppercase text-[10px] pr-2">Totais:</td><td class="text-right text-xs" id="comm-total-hours">0h</td><td class="text-right text-xs text-green-700 bg-green-50" id="comm-total-rev">R$ 0,00</td><td class="text-right text-xs text-red-600" id="comm-total-cost">R$ 0,00</td><td class="text-right text-xs text-blue-600" id="comm-total-margin">0%</td><td></td></tr></tfoot></table><div class="p-2 bg-gray-50 border-t border-gray-200"><button onclick="addCommercialRow()" class="w-full bg-white border border-gray-300 text-gray-700 text-xs px-3 py-2 rounded font-bold hover:bg-gray-100 flex items-center justify-center gap-2"><i data-lucide="plus" class="w-3 h-3"></i> Adicionar Item Comercial</button></div></div>
                    <div class="mt-6"><div class="flex justify-between items-center mb-2"><h5 class="font-bold text-gray-700 text-xs uppercase">Forecast Comercial (Mensal)</h5><div class="flex gap-2"><label class="text-xs font-bold text-gray-500 pt-1">Ano:</label><input type="number" id="forecast-year-comm" class="w-16 border rounded text-center text-xs" value="2026" onchange="refreshAllForecasts()"></div></div><div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="w-full text-left table-dense"><thead class="bg-gray-50 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr id="monthly-forecast-header"></tr></thead><tbody id="monthly-forecast-body" class="bg-white"></tbody></table></div></div>
                </div>
                <div id="view-execution" class="hidden space-y-6">
                     <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg flex justify-between items-center"><div><h4 class="text-sm font-bold text-indigo-800">Alocação de Recursos</h4><p class="text-[10px] text-indigo-600">Receita ponderada pelo custo incorrido.</p></div></div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg mt-4"><table class="w-full text-left table-dense"><thead class="bg-gray-100 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr><th class="w-40">Item Vendido</th><th class="w-48">Profissional</th><th class="text-right w-24">Taxa Venda</th><th class="text-right w-24">Custo Hr</th><th class="text-center w-24">Início</th><th class="text-center w-24">Fim</th><th class="text-center w-12">%</th><th class="text-center w-12">Dias</th><th class="text-right w-20">Hrs</th><th class="text-right w-28 bg-green-50">Rec. Ponderada</th><th class="text-right w-28">Custo Prev.</th><th class="text-right w-16">Margem</th><th class="w-8"></th></tr></thead><tbody id="execution-rows" class="divide-y divide-gray-100 bg-white"></tbody><tfoot class="bg-gray-50 font-bold text-gray-700 border-t border-gray-200"><tr><td colspan="7" class="text-right uppercase text-[10px] pr-2">Totais:</td><td class="text-center text-xs" id="exec-total-days">0</td><td class="text-right text-xs" id="exec-total-hours">0h</td><td class="text-right text-xs text-green-700 bg-green-50" id="exec-total-rev">R$ 0,00</td><td class="text-right text-xs text-red-600" id="exec-total-cost">R$ 0,00</td><td class="text-right text-xs text-blue-600" id="exec-total-margin">0%</td><td></td></tr></tfoot></table><div class="p-2 bg-gray-50 border-t border-gray-200"><button onclick="addExecutionRow()" class="w-full bg-white border border-gray-300 text-gray-700 text-xs px-3 py-2 rounded font-bold hover:bg-gray-100 flex items-center justify-center gap-2"><i data-lucide="user-plus" class="w-3 h-3"></i> Adicionar Profissional</button></div></div>
                    <div class="mt-6"><div class="flex justify-between items-center mb-2"><h5 class="font-bold text-gray-700 text-xs uppercase">Forecast Alocação (Mensal)</h5><div class="flex gap-2"><label class="text-xs font-bold text-gray-500 pt-1">Ano:</label><input type="number" id="forecast-year-alloc" class="w-16 border rounded text-center text-xs" value="2026" onchange="refreshAllForecasts()"></div></div><div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="w-full text-left table-dense"><thead class="bg-gray-50 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr id="alloc-forecast-header"></tr></thead><tbody id="alloc-forecast-body" class="bg-white"></tbody></table></div></div>
                </div>
                <div id="view-realized" class="hidden space-y-6">
                    <div class="bg-teal-50 border border-teal-200 p-4 rounded-lg"><h4 class="text-sm font-bold text-teal-800">Execução Real (Timesheet)</h4><p class="text-[10px] text-teal-600">Dados baseados em apontamentos reais.</p></div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg mt-4"><table class="w-full text-left table-dense"><thead class="bg-gray-100 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr><th class="w-48">Profissional</th><th class="text-right">Hrs Lançadas</th><th class="text-right">Custo Incorrido</th><th class="text-right">Preço Venda</th><th class="text-right">Receita Medida</th><th class="text-right">Margem Real</th></tr></thead><tbody id="realized-rows" class="divide-y divide-gray-100 bg-white"></tbody></table></div>
                    <div class="mt-6"><div class="flex justify-between items-center mb-2"><h5 class="font-bold text-gray-700 text-xs uppercase">Forecast Realizado (Mensal)</h5><div class="flex gap-2"><label class="text-xs font-bold text-gray-500 pt-1">Ano:</label><input type="number" id="forecast-year-real" class="w-16 border rounded text-center text-xs" value="2026" onchange="refreshAllForecasts()"></div></div><div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="w-full text-left table-dense"><thead class="bg-gray-50 font-bold text-gray-600 border-b border-gray-200 text-[10px] uppercase"><tr id="realized-forecast-header"></tr></thead><tbody id="realized-forecast-body" class="bg-white"></tbody></table></div></div>
                </div>
                <div id="view-financial" class="hidden space-y-6">
                    <div class="flex justify-between items-center mb-4"><h4 class="text-sm font-bold text-gray-800">DRE do Projeto Detalhada (Todo o Período)</h4></div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm"><table class="w-full text-left table-dense"><thead class="bg-gray-800 text-white font-bold text-[10px] uppercase"><tr><th class="w-24 py-3">Mês/Ano</th><th class="text-right bg-gray-700 px-2">Rec. Vendida</th><th class="text-right bg-gray-700 px-2">Custo Vendido</th><th class="text-right border-r border-gray-600 px-2">Margem</th><th class="text-right bg-indigo-900 px-2">Rec. Prevista</th><th class="text-right bg-indigo-900 px-2">Custo Prev.</th><th class="text-right border-r border-gray-600 px-2">Margem</th><th class="text-right bg-teal-900 px-2">Rec. Real</th><th class="text-right bg-teal-900 px-2">Custo Real</th><th class="text-right px-2">Margem</th></tr></thead><tbody id="financial-grid" class="divide-y divide-gray-200 bg-white"></tbody><tfoot id="financial-foot" class="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300"></tfoot></table></div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL UPLOAD -->
    <div id="upload-modal" class="fixed inset-0 modal-backdrop hidden flex items-center justify-center p-4 z-[120]">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="upload" class="w-5 h-5 text-indigo-600"></i> Anexar Arquivo</h3>
                <button onclick="document.getElementById('upload-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tipo de Documento</label>
                    <select id="doc-type-select" class="w-full text-xs border border-gray-300 rounded-lg p-2.5 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none"><option>Proposta Comercial</option><option>Contrato</option><option>Pricing</option><option>Outros</option></select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Arquivo</label>
                    <input type="file" id="file-input" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="document.getElementById('upload-modal').classList.add('hidden')" class="px-4 py-2 text-xs font-bold text-gray-500 hover:text-gray-700">Cancelar</button>
                    <button onclick="uploadFile()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg shadow-lg transition-transform active:scale-95">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-[60]"><i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i><div><p class="text-sm font-bold" id="toast-title"></p><p class="text-xs text-gray-400" id="toast-message"></p></div></div>

    <script>
        lucide.createIcons();
        let services = <%- JSON.stringify(services) %>;
        let currentServiceData = null; let metadata = {}; 
        let attachedDocIds = []; 

        const money = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const moneyValue = (val) => money.format(val || 0);
        const holidays = ["01/01", "21/04", "01/05", "07/09", "12/10", "02/11", "15/11", "25/12"];

        // --- GLOBAL HELPERS & CALCS ---
        function calculateMargin(revenue, cost) {
            if (revenue > 0) return Math.round(((revenue - cost) / revenue) * 100);
            if (cost > 0) return -100;
            return 0;
        }

        function countBusinessDays(startDate, endDate) {
            if(!startDate || !endDate) return 0;
            const s = startDate.split('-'); const e = endDate.split('-');
            const start = new Date(s[0], s[1]-1, s[2]); const end = new Date(e[0], e[1]-1, e[2]);
            if(start > end) return 0;
            let days = 0; let cur = new Date(start);
            while(cur <= end) {
                const d = cur.getDay();
                const dStr = String(cur.getDate()).padStart(2,'0') + '/' + String(cur.getMonth()+1).padStart(2,'0');
                if(d !== 0 && d !== 6 && !holidays.includes(dStr)) days++;
                cur.setDate(cur.getDate() + 1);
            }
            return days;
        }

        function updateSummaryCards(cRev, cMargin, fRev, fMargin, aRev, aMargin) {
            document.getElementById('card-prop-rev').innerText = moneyValue(cRev); document.getElementById('card-prop-margin').innerText = cMargin + '%';
            document.getElementById('card-fcst-rev').innerText = moneyValue(fRev); document.getElementById('card-fcst-margin').innerText = fMargin + '%';
            document.getElementById('card-act-rev').innerText = moneyValue(aRev); document.getElementById('card-act-margin').innerText = aMargin + '%';
        }

        function calculateAllTotals() {
            let cRev=0, cCost=0, cHours=0;
            document.querySelectorAll('.comm-row').forEach(tr => {
                cRev += parseFloat(tr.querySelector('.cell-rev').innerText.replace(/[^0-9,-]+/g,"").replace(",",".")||0);
                cCost += parseFloat(tr.querySelector('.cell-cost').innerText.replace(/[^0-9,-]+/g,"").replace(",",".")||0);
                cHours += parseFloat(tr.querySelector('.cell-hours').innerText.replace('h','')||0);
            });
            document.getElementById('comm-total-hours').innerText = cHours.toFixed(1) + 'h';
            document.getElementById('comm-total-rev').innerText = moneyValue(cRev);
            document.getElementById('comm-total-cost').innerText = moneyValue(cCost);
            document.getElementById('comm-total-margin').innerText = calculateMargin(cRev, cCost) + '%';

            let aRev=0, aCost=0, aHours=0, aDays=0;
            document.querySelectorAll('.exec-row').forEach(tr => {
                 aRev += parseFloat(tr.querySelector('.cell-rev').innerText.replace(/[^0-9,-]+/g,"").replace(",",".")||0);
                 aCost += parseFloat(tr.querySelector('.cell-cost').innerText.replace(/[^0-9,-]+/g,"").replace(",",".")||0);
                 aHours += parseFloat(tr.querySelector('.cell-hours').innerText.replace('h','')||0);
                 aDays += parseInt(tr.querySelector('.cell-days').innerText||0);
            });
            document.getElementById('exec-total-days').innerText = aDays; document.getElementById('exec-total-hours').innerText = aHours.toFixed(1) + 'h';
            document.getElementById('exec-total-rev').innerText = moneyValue(aRev); document.getElementById('exec-total-cost').innerText = moneyValue(aCost);
            document.getElementById('exec-total-margin').innerText = calculateMargin(aRev, aCost) + '%';

            // VALORES ATUAIS (REALIZADOS) - Vêm do Banco de Dados via currentServiceData
            const rRev = currentServiceData?.act?.rev || 0;
            const rMargin = currentServiceData?.act?.margin || 0;
            console.log(`[calculateAllTotals] currentServiceData.id: ${currentServiceData?.id}, rRev: ${rRev}, rMargin: ${rMargin}`);

            updateSummaryCards(cRev, calculateMargin(cRev, cCost), aRev, calculateMargin(aRev, aCost), rRev, rMargin);
        }

        function recalcDistribution() {
            const distributionMap = {};
            document.querySelectorAll('.exec-row').forEach(tr => {
                const commId = tr.cells[0].querySelector('select').value;
                const costRate = parseFloat(tr.cells[3].querySelector('input').value) || 0;
                const start = tr.cells[4].querySelector('input').value;
                const end = tr.cells[5].querySelector('input').value;
                const alloc = parseFloat(tr.cells[6].querySelector('input').value) || 0;
                const days = countBusinessDays(start, end);
                const totalHours = days * 8 * (alloc / 100); 
                const totalCost = totalHours * costRate;
                tr.dataset.tempCost = totalCost; tr.dataset.tempHours = totalHours; tr.dataset.tempDays = days; 
                
                // Atualiza métricas base (sempre)
                tr.querySelector('.cell-days').innerText = days; 
                tr.querySelector('.cell-hours').innerText = totalHours.toFixed(1) + 'h';
                tr.querySelector('.cell-cost').innerText = moneyValue(totalCost);

                if(commId) {
                    if(!distributionMap[commId]) distributionMap[commId] = { totalCostIncurred: 0, rows: [] };
                    distributionMap[commId].totalCostIncurred += totalCost; distributionMap[commId].rows.push(tr);
                } else {
                    // Sem venda: No Billable
                    tr.cells[2].querySelector('input').value = '0.00';
                    tr.querySelector('.cell-rev').innerText = moneyValue(0);
                    tr.querySelector('.cell-margin').innerText = calculateMargin(0, totalCost) + '%';
                }
            });
            Object.keys(distributionMap).forEach(commId => {
                const group = distributionMap[commId];
                const commRow = document.querySelector(`.comm-row[data-id="${commId}"]`);
                const commRev = commRow ? parseFloat(commRow.querySelector('.cell-rev').innerText.replace(/[^0-9,-]+/g,"").replace(",",".") || 0) : 0;
                group.rows.forEach(tr => {
                    const myCost = parseFloat(tr.dataset.tempCost); const myHours = parseFloat(tr.dataset.tempHours);
                    let myShareRev = (group.totalCostIncurred > 0) ? (commRev * myCost) / group.totalCostIncurred : 0;
                    tr.cells[2].querySelector('input').value = myHours > 0 ? (myShareRev / myHours).toFixed(2) : '0.00';
                    tr.querySelector('.cell-rev').innerText = moneyValue(myShareRev);
                    tr.querySelector('.cell-margin').innerText = calculateMargin(myShareRev, myCost) + '%';
                });
            });
            calculateAllTotals(); updateRealizedView(); refreshAllForecasts();
        }

        function updateRealizedView() {
            const rows = document.getElementById('realized-rows');
            if (!rows) return;
            rows.innerHTML = '';
            
            let totalHours = 0, totalCost = 0, totalRevenue = 0;

            if (currentServiceData && currentServiceData.execution) {
                currentServiceData.execution.forEach(item => {
                    const person = item.person || 'Indefinido';
                    const hours = item.totalRealizedHours || 0;
                    const cost = item.totalRealizedCost || 0;
                    const salePrice = item.saleApplied || 0;
                    const measuredRevenue = item.totalRealizedRevenue || 0;
                    const realizedMargin = calculateMargin(measuredRevenue, cost);

                    rows.innerHTML += `
                        <tr>
                            <td class="px-2 py-2 text-xs text-gray-700">${person}</td>
                            <td class="px-2 py-2 text-right text-xs font-bold text-gray-600">${hours.toFixed(1)}h</td>
                            <td class="px-2 py-2 text-right text-xs text-red-600">${moneyValue(cost)}</td>
                            <td class="px-2 py-2 text-right text-xs text-blue-600">${moneyValue(salePrice)}</td>
                            <td class="px-2 py-2 text-right text-xs font-bold text-green-700">${moneyValue(measuredRevenue)}</td>
                            <td class="px-2 py-2 text-right text-xs font-bold text-indigo-600">${realizedMargin.toFixed(0)}%</td>
                        </tr>`;
                    
                    totalHours += hours;
                    totalCost += cost;
                    totalRevenue += measuredRevenue;
                });
            }
            
            // Add footer with totals
            const table = rows.parentElement;
            let tfoot = table.querySelector('tfoot');
            if (tfoot) tfoot.remove(); // Remove existing footer to prevent duplicates
            
            tfoot = document.createElement('tfoot');
            tfoot.className = "bg-gray-50 font-bold text-gray-700 border-t-2 border-gray-200";
            
            const totalMargin = calculateMargin(totalRevenue, totalCost);

            tfoot.innerHTML = `
                <tr>
                    <td class="px-2 py-2 text-right text-[10px] uppercase">Totais:</td>
                    <td class="px-2 py-2 text-right text-xs">${totalHours.toFixed(1)}h</td>
                    <td class="px-2 py-2 text-right text-xs text-red-700">${moneyValue(totalCost)}</td>
                    <td class="px-2 py-2"></td>
                    <td class="px-2 py-2 text-right text-xs text-green-800">${moneyValue(totalRevenue)}</td>
                    <td class="px-2 py-2 text-right text-xs text-indigo-700">${totalMargin.toFixed(0)}%</td>
                </tr>
            `;
            table.appendChild(tfoot);
        }

        function showToast(title, message, color = 'green') {
            const el = document.getElementById('toast');
            if(!el) return;
            const icon = el.querySelector('i');
            const titleEl = document.getElementById('toast-title');
            
            titleEl.innerText = title;
            document.getElementById('toast-message').innerText = message;
            
            if(icon) {
                if (color === 'red') {
                    icon.classList.remove('text-green-400');
                    icon.classList.add('text-red-400');
                    icon.setAttribute('data-lucide', 'alert-circle');
                } else {
                    icon.classList.remove('text-red-400');
                    icon.classList.add('text-green-400');
                    icon.setAttribute('data-lucide', 'check-circle');
                }
                lucide.createIcons();
            }

            el.classList.remove('translate-y-20','opacity-0'); 
            setTimeout(() => el.classList.add('translate-y-20','opacity-0'), 3000); 
        }

        function generateRealizedForecast(year) {
            const forecast = Array.from({length: 12}, () => ({ rev: 0, cost: 0 }));
            if (!currentServiceData || !currentServiceData.execution) return forecast;

            currentServiceData.execution.forEach(execItem => {
                if (execItem.monthlyRealized) {
                    execItem.monthlyRealized.forEach(realMonth => {
                        const monthDate = new Date(realMonth.month + 'T00:00:00');
                        if (monthDate.getFullYear() === year) {
                            const monthIndex = monthDate.getMonth();
                            forecast[monthIndex].rev += realMonth.revenue;
                            forecast[monthIndex].cost += realMonth.cost;
                        }
                    });
                }
            });
            return forecast;
        }

        function refreshAllForecasts() {
            const yrComm = parseInt(document.getElementById('forecast-year-comm').value);
            const yrAlloc = parseInt(document.getElementById('forecast-year-alloc').value);
            const yrReal = parseInt(document.getElementById('forecast-year-real').value);
            const cMonths = generatePreciseForecast('comm-row', yrComm); renderMonthlyTable(cMonths, 'monthly-forecast-header', 'monthly-forecast-body', yrComm);
            const aMonths = generatePreciseForecast('exec-row', yrAlloc); renderMonthlyTable(aMonths, 'alloc-forecast-header', 'alloc-forecast-body', yrAlloc);
            const rMonths = generateRealizedForecast(yrReal);
            renderMonthlyTable(rMonths, 'realized-forecast-header', 'realized-forecast-body', yrReal);
            generateDREDetailed();
        }

        function generatePreciseForecast(rowClass, year) {
            const forecast = Array.from({length: 12}, () => ({ rev: 0, cost: 0 }));
            const isComm = rowClass === 'comm-row';
            const idxStart = isComm ? 3 : 4; const idxEnd = isComm ? 4 : 5; const idxSale = isComm ? 1 : 2; const idxCost = isComm ? 2 : 3; const idxAlloc = 6; 
            document.querySelectorAll('.' + rowClass).forEach(tr => {
                const sVal = tr.cells[idxStart].querySelector('input').value; const eVal = tr.cells[idxEnd].querySelector('input').value;
                if(!sVal || !eVal) return;
                const sParts = sVal.split('-'); const start = new Date(sParts[0], sParts[1]-1, sParts[2]);
                const eParts = eVal.split('-'); const end = new Date(eParts[0], eParts[1]-1, eParts[2]);
                const saleRate = parseFloat(tr.cells[idxSale].querySelector('input').value) || 0;
                const costRate = parseFloat(tr.cells[idxCost].querySelector('input').value) || 0;
                const alloc = parseFloat(tr.cells[idxAlloc].querySelector('input').value) || 0;
                const hoursPerDay = 8 * (alloc/100);
                let cur = new Date(start);
                while(cur <= end) {
                    if(cur.getFullYear() === year) {
                        const dayStr = String(cur.getDate()).padStart(2,'0') + '/' + String(cur.getMonth()+1).padStart(2,'0');
                        if(cur.getDay() !== 0 && cur.getDay() !== 6 && !holidays.includes(dayStr)) {
                            const m = cur.getMonth(); forecast[m].rev += (hoursPerDay * saleRate); forecast[m].cost += (hoursPerDay * costRate);
                        }
                    }
                    cur.setDate(cur.getDate() + 1);
                }
            });
            return forecast;
        }

        function renderMonthlyTable(data, headId, bodyId, year) {
            const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
            let h = '<th class="w-24">Métrica</th>', bRev = '<tr><td>Receita</td>', bCost = '<tr><td>Custo</td>', bMarg = '<tr><td>Margem</td>';
            let tRev=0, tCost=0;
            data.forEach((d, i) => {
                h += `<th class="text-right px-2 font-bold text-gray-500">${months[i]}/${year.toString().substr(2)}</th>`;
                bRev += `<td class="text-right text-xs text-gray-600">${moneyValue(d.rev)}</td>`;
                bCost += `<td class="text-right text-xs text-red-500">${moneyValue(d.cost)}</td>`;
                const marg = calculateMargin(d.rev, d.cost);
                bMarg += `<td class="text-right text-xs text-blue-600 font-bold">${marg}%</td>`;
                tRev += d.rev; tCost += d.cost;
            });
            const tMarg = calculateMargin(tRev, tCost);
            h += '<th class="text-right px-2 bg-gray-50">Total</th>';
            bRev += `<td class="text-right font-bold text-xs bg-gray-50 text-green-700">${moneyValue(tRev)}</td></tr>`;
            bCost += `<td class="text-right font-bold text-xs bg-gray-50 text-red-600">${moneyValue(tCost)}</td></tr>`;
            bMarg += `<td class="text-right font-bold text-xs bg-gray-50 text-blue-700">${tMarg}%</td></tr>`;
            document.getElementById(headId).innerHTML = h; document.getElementById(bodyId).innerHTML = bRev + bCost + bMarg;
        }

function generateDREDetailed() {
            let minDate, maxDate;
            const processRows = (selector, iStart, iEnd) => {
                document.querySelectorAll(selector).forEach(tr => {
                    const s = tr.cells[iStart].querySelector('input').value; const e = tr.cells[iEnd].querySelector('input').value;
                    if(s && (!minDate || s < minDate)) minDate = s;
                    if(e && (!maxDate || e > maxDate)) maxDate = e;
                });
            };
            processRows('.comm-row', 3, 4); processRows('.exec-row', 4, 5);
            if(!minDate || !maxDate) return;
            const months = []; let cur = new Date(minDate.split('-')[0], minDate.split('-')[1]-1, 1);
            const end = new Date(maxDate.split('-')[0], maxDate.split('-')[1]-1, 1); 
            while(cur <= end) { months.push(new Date(cur)); cur.setMonth(cur.getMonth() + 1); }
            
            const cData = months.map(m => calcMonthData('.comm-row', m, 3, 4, 1, 2, 6));
            const aData = months.map(m => calcMonthData('.exec-row', m, 4, 5, 2, 3, 6));
            
            const serviceMonthlyRealized = {}; // { 'YYYY-MM-DD': { rev: sumRev, cost: sumCost } }
            if (currentServiceData && currentServiceData.execution) {
                currentServiceData.execution.forEach(execItem => {
                    if (execItem.monthlyRealized) {
                        execItem.monthlyRealized.forEach(monthData => {
                            const monthKey = monthData.month; // Competencia__c comes as YYYY-MM-DD from backend
                            if (!serviceMonthlyRealized[monthKey]) {
                                serviceMonthlyRealized[monthKey] = { rev: 0, cost: 0 };
                            }
                            serviceMonthlyRealized[monthKey].rev += monthData.revenue;
                            serviceMonthlyRealized[monthKey].cost += monthData.cost;
                        });
                    }
                });
            }

            const rData = months.map(targetMonth => {
                const targetMonthStr = targetMonth.toISOString().split('T')[0];
                const aggregatedData = serviceMonthlyRealized[targetMonthStr];
                return {
                    rev: aggregatedData ? aggregatedData.rev : 0,
                    cost: aggregatedData ? aggregatedData.cost : 0,
                };
            });
            let html = '';
            months.forEach((m, i) => {
                const c = cData[i], a = aData[i], r = rData[i];
                const cMarg = calculateMargin(c.rev, c.cost);
                const aMarg = calculateMargin(a.rev, a.cost);
                const rMarg = calculateMargin(r.rev, r.cost);
                html += `<tr><td class="font-bold text-xs capitalize">${m.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })}</td><td class="text-right text-xs text-gray-600">${moneyValue(c.rev)}</td><td class="text-right text-xs text-red-400">${moneyValue(c.cost)}</td><td class="text-right text-xs font-bold border-r border-gray-200">${cMarg}%</td><td class="text-right text-xs text-indigo-600">${moneyValue(a.rev)}</td><td class="text-right text-xs text-red-400">${moneyValue(a.cost)}</td><td class="text-right text-xs font-bold border-r border-gray-200">${aMarg}%</td><td class="text-right text-xs text-green-600">${moneyValue(r.rev)}</td><td class="text-right text-xs text-red-400">${moneyValue(r.cost)}</td><td class="text-right text-xs font-bold">${rMarg}%</td></tr>`;
            });
            const sum = (arr, k) => arr.reduce((a,b) => a + b[k], 0);
            const ctRev = sum(cData,'rev'), ctCost = sum(cData,'cost');
            const atRev = sum(aData,'rev'), atCost = sum(aData,'cost');
            const rtRev = sum(rData,'rev'), rtCost = sum(rData,'cost');
            const footHtml = `<tr class="bg-gray-100 font-bold border-t border-gray-300"><td class="py-2">TOTAL</td><td class="text-right text-xs">${moneyValue(ctRev)}</td><td class="text-right text-xs">${moneyValue(ctCost)}</td><td class="text-right text-xs border-r border-gray-300">${calculateMargin(ctRev, ctCost)}%</td><td class="text-right text-xs text-indigo-800">${moneyValue(atRev)}</td><td class="text-right text-xs text-indigo-800">${moneyValue(atCost)}</td><td class="text-right text-xs border-r border-gray-200">${calculateMargin(atRev, atCost)}%</td><td class="text-right text-xs text-green-800">${moneyValue(rtRev)}</td><td class="text-right text-xs text-green-800">${moneyValue(rtCost)}</td><td class="text-right text-xs">${calculateMargin(rtRev, rtCost)}%</td></tr>`;
            document.getElementById('financial-grid').innerHTML = html; document.getElementById('financial-foot').innerHTML = footHtml;
        }

        function calcMonthData(selector, targetMonth, iStart, iEnd, iSale, iCost, iAlloc) {
            let rev = 0, cost = 0;
            document.querySelectorAll(selector).forEach(tr => {
                const sVal = tr.cells[iStart].querySelector('input').value; const eVal = tr.cells[iEnd].querySelector('input').value;
                if(!sVal || !eVal) return;
                const s = sVal.split('-'); const e = eVal.split('-');
                const start = new Date(s[0], s[1]-1, s[2]); const end = new Date(e[0], e[1]-1, e[2]);
                const mStart = new Date(targetMonth.getFullYear(), targetMonth.getMonth(), 1); const mEnd = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0);
                if (start <= mEnd && end >= mStart) {
                    const overlapStart = start > mStart ? start : mStart; const overlapEnd = end < mEnd ? end : mEnd;
                    const days = countBusinessDays(overlapStart.toISOString().split('T')[0], overlapEnd.toISOString().split('T')[0]);
                    if(days > 0) {
                        const saleRate = parseFloat(tr.cells[iSale].querySelector('input').value) || 0;
                        const costRate = parseFloat(tr.cells[iCost].querySelector('input').value) || 0;
                        const hours = days * 8 * ((parseFloat(tr.cells[iAlloc].querySelector('input').value) || 0)/100);
                        rev += hours * saleRate; cost += hours * costRate;
                    }
                }
            });
            return { rev, cost };
        }

        // --- DOM HELPERS ---
        function getProductOptions(selectedName) { 
            const pbId = document.getElementById('select-pricebook').value;
            const pb = (metadata.pricebooks || []).find(p => p.id === pbId);
            if (!pb) return '<option value="">Selecione a Tabela...</option>';
            return '<option value="">Selecione...</option>' + (pb.products || []).map(p => 
                `<option value="${p.name}" data-price="${p.price}" data-cost="${p.cost}" ${p.name === selectedName ? 'selected' : ''}>${p.name}</option>`
            ).join(''); 
        }
        function getCommLinkOptions(selectedId) {
            let opts = '<option value="">Selecione...</option>';
            document.querySelectorAll('.comm-row').forEach((tr, index) => {
                const prodName = tr.cells[0].querySelector('select').value;
                const price = tr.cells[1].querySelector('input').value;
                const start = tr.cells[3].querySelector('input').value;
                const end = tr.cells[4].querySelector('input').value;
                const sFmt = start ? start.split('-').reverse().join('/') : '?';
                const eFmt = end ? end.split('-').reverse().join('/') : '?';
                const label = `#${index + 1} - ${prodName} (R$ ${price}) [${sFmt} a ${eFmt}]`;
                opts += `<option value="${tr.dataset.id}" ${tr.dataset.id === selectedId ? 'selected' : ''}>${label}</option>`;
            });
            return opts;
        }
        function getPeopleOptions(selectedName) { return '<option value="">Selecione...</option>' + (metadata.people || []).map(p => `<option value="${p.name}" data-id="${p.id}" data-cost="${p.costRate}" ${p.name === selectedName ? 'selected' : ''}>${p.name}</option>`).join(''); }
        function populateDatalist(id, list) { document.getElementById(id).innerHTML = (list||[]).map(item => `<option value="${item.name}" data-id="${item.id}">`).join(''); }
        function getMetadataName(list, id) { return (list || []).find(i => i.id === id)?.name || null; }

        function deleteDocument(docId) {
            if(!confirm("Deseja realmente remover este anexo?")) return;
            document.getElementById('modal-loader').classList.remove('hidden');
            fetch(`/api/services/doc/${docId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                document.getElementById('modal-loader').classList.add('hidden');
                if(data.success) {
                    const el = document.getElementById(`doc-${docId}`);
                    if(el) el.remove();
                    attachedDocIds = attachedDocIds.filter(id => id !== docId);
                    if(attachedDocIds.length === 0) {
                        const container = document.getElementById('docs-list-container');
                        if(container) container.innerHTML = '<p class="text-xs text-gray-400 text-center italic">Nenhum documento anexado.</p>';
                    }
                    showToast('Removido', 'Anexo excluído.');
                } else {
                    showToast('Erro', 'Erro ao excluir: ' + (data.message || data.error), 'red');
                }
            }).catch(err => {
                document.getElementById('modal-loader').classList.add('hidden');
                showToast('Erro', 'Erro ao excluir documento.', 'red');
            });
        }

        // --- CORE FUNCTIONS ---
        function getItemMonthlyData(tr) {
            const sVal = tr.cells[3].querySelector('input').value; 
            const eVal = tr.cells[4].querySelector('input').value;
            if(!sVal || !eVal) return [];

            const sParts = sVal.split('-'); const start = new Date(sParts[0], sParts[1]-1, sParts[2]);
            const eParts = eVal.split('-'); const end = new Date(eParts[0], eParts[1]-1, eParts[2]);
            
            const saleRate = parseFloat(tr.cells[1].querySelector('input').value) || 0;
            const costRate = parseFloat(tr.cells[2].querySelector('input').value) || 0;
            const alloc = parseFloat(tr.cells[6].querySelector('input').value) || 0;
            const hoursPerDay = 8 * (alloc/100);

            const monthlyData = [];
            let cur = new Date(start.getFullYear(), start.getMonth(), 1);
            const endDateOnly = new Date(end.getFullYear(), end.getMonth(), 1);

            while(cur <= endDateOnly) {
                const mStart = new Date(cur.getFullYear(), cur.getMonth(), 1); 
                const mEnd = new Date(cur.getFullYear(), cur.getMonth() + 1, 0);
                
                const overlapStart = start > mStart ? start : mStart; 
                const overlapEnd = end < mEnd ? end : mEnd;
                
                // Formatar para YYYY-MM-DD para garantir compatibilidade com helper
                const d1 = overlapStart.toISOString().split('T')[0];
                const d2 = overlapEnd.toISOString().split('T')[0];

                const days = countBusinessDays(d1, d2);
                
                if (days > 0) {
                    const hours = days * hoursPerDay;
                    monthlyData.push({
                        date: mStart.toISOString().split('T')[0], // Data base do mês (dia 1)
                        rev: hours * saleRate,
                        cost: hours * costRate
                    });
                }
                cur.setMonth(cur.getMonth() + 1);
            }
            return monthlyData;
        }

        function getExecutionMonthlyData(tr) {
            const sVal = tr.cells[4].querySelector('input').value; 
            const eVal = tr.cells[5].querySelector('input').value;
            if(!sVal || !eVal) return [];

            const sParts = sVal.split('-'); const start = new Date(sParts[0], sParts[1]-1, sParts[2]);
            const eParts = eVal.split('-'); const end = new Date(eParts[0], eParts[1]-1, eParts[2]);
            
            // Taxa de Venda Efetiva (calculada pelo rateio)
            const effectiveSaleRate = parseFloat(tr.cells[2].querySelector('input').value) || 0;
            // Custo Hora do Profissional
            const costRate = parseFloat(tr.cells[3].querySelector('input').value) || 0;
            // Percentual de Alocação
            const alloc = parseFloat(tr.cells[6].querySelector('input').value) || 0;
            const hoursPerDay = 8 * (alloc/100);

            const monthlyData = [];
            let cur = new Date(start.getFullYear(), start.getMonth(), 1);
            const endDateOnly = new Date(end.getFullYear(), end.getMonth(), 1);

            while(cur <= endDateOnly) {
                const mStart = new Date(cur.getFullYear(), cur.getMonth(), 1); 
                const mEnd = new Date(cur.getFullYear(), cur.getMonth() + 1, 0);
                
                const overlapStart = start > mStart ? start : mStart; 
                const overlapEnd = end < mEnd ? end : mEnd;
                
                const d1 = overlapStart.toISOString().split('T')[0];
                const d2 = overlapEnd.toISOString().split('T')[0];

                const days = countBusinessDays(d1, d2);
                
                if (days > 0) {
                    const hours = days * hoursPerDay;
                    monthlyData.push({
                        date: mStart.toISOString().split('T')[0],
                        rev: hours * effectiveSaleRate,
                        cost: hours * costRate
                    });
                }
                cur.setMonth(cur.getMonth() + 1);
            }
            return monthlyData;
        }

        function renderServices(list = services) {
            const grid = document.getElementById('services-grid'); grid.innerHTML = '';
            if (list.length === 0) { document.getElementById('no-results').classList.remove('hidden'); document.getElementById('no-results').classList.add('flex'); }
            else {
                document.getElementById('no-results').classList.add('hidden'); document.getElementById('no-results').classList.remove('flex');
                list.forEach(s => {
                    const statusClass = s.status === 'Ativo' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-red-50 text-red-700 border-red-100';
                    const formatDateBR = (dateStr) => { if(!dateStr) return '-'; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y.substr(2)}`; };
                    grid.innerHTML += `<div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer group" onclick="openServiceModal('${s.id}')"><div class="p-5 border-b border-gray-100 flex justify-between items-start"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-100 uppercase">${s.type || 'Projeto'}</span><span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase">${s.client || 'Novo'}</span><span class="${statusClass} text-[10px] font-bold px-2 py-0.5 rounded border uppercase">${s.status}</span></div><h3 class="text-lg font-bold text-gray-800 group-hover:text-indigo-600 transition-colors">${s.name || 'Sem Nome'}</h3><div class="flex gap-4 mt-2 text-[10px] text-gray-500"><span><b class="text-gray-400">INÍCIO:</b> ${formatDateBR(s.dataInicio)}</span><span><b class="text-gray-400">FIM ORIG.:</b> ${formatDateBR(s.dataFimOriginal)}</span><span><b class="text-gray-400">FIM REAL:</b> ${formatDateBR(s.dataFim)}</span></div></div><div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-indigo-50 group-hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></div></div><div class="p-4 grid grid-cols-3 gap-2 text-center text-xs divide-x divide-gray-100 bg-gray-50/50 rounded-b-xl"><div><p class="text-gray-400 font-bold uppercase text-[10px]">Vendido</p><p class="font-bold text-gray-700 mt-1">${moneyValue(s.prop?.rev)}</p><p class="text-[10px] text-blue-600 font-bold">${s.prop?.margin||0}%</p></div><div><p class="text-gray-400 font-bold uppercase text-[10px]">Previsto</p><p class="font-bold text-gray-700 mt-1">${moneyValue(s.fcst?.rev)}</p><p class="text-[10px] text-indigo-600 font-bold">${s.fcst?.margin||0}%</p></div><div><p class="text-gray-400 font-bold uppercase text-[10px]">Atual</p><p class="font-bold text-gray-700 mt-1">${moneyValue(s.act?.rev)}</p><p class="text-[10px] text-green-600 font-bold">${s.act?.margin||0}%</p></div></div></div>`;
                });
            }
            lucide.createIcons();
        }

        function filterServices() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            fetch(`/api/services?status=${status}`).then(res => res.json()).then(data => {
                services = data;
                const filtered = services.filter(s => (s.name||'').toLowerCase().includes(query) || (s.client||'').toLowerCase().includes(query));
                renderServices(filtered);
            });
        }

        function openServiceModal(id = null) {
            // FEEDBACK VISUAL IMEDIATO
            document.getElementById('service-modal').classList.remove('hidden');
            document.getElementById('modal-loader').classList.remove('hidden');
            
            const title = id ? "Editar Serviço" : "Novo Serviço";
            document.getElementById('modal-svc-title').innerText = title;
            document.getElementById('badge-status').innerText = id ? "Em Edição" : "Novo";
            switchTab('general');

            if(!id) {
                ['input-svc-name', 'input-sf-account', 'input-ca-client', 'input-lead-project', 'input-coordinator', 'input-tech-lead', 'input-svc-start', 'input-svc-end-orig', 'input-svc-end-real'].forEach(i => {
                    const el = document.getElementById(i); if(el) el.value = '';
                });
                document.getElementById('commercial-rows').innerHTML = '';
                document.getElementById('execution-rows').innerHTML = '';
                document.getElementById('svc-billing-list').innerHTML = '';
                document.getElementById('docs-list-container').innerHTML = '<p class="text-xs text-gray-400 text-center italic">Nenhum documento anexado.</p>';
                attachedDocIds = [];
                updateSummaryCards(0,0,0,0,0,0);
            }

            const endpoint = id ? `/api/services/${id}` : `/api/services/new`;
            
            // Pequeno delay para permitir o render do loader antes do fetch (UX)
            setTimeout(() => {
                fetch(endpoint).then(res => res.json()).then(data => {
                    currentServiceData = data;
                    metadata = data.metadata || {};
                    populateDatalist('sf-accounts-list', metadata.salesforceAccounts);
                    populateDatalist('ca-clients-list', metadata.contaAzulClients);
                    populateDatalist('people-list', metadata.people);
                    
                    const pbSelect = document.getElementById('select-pricebook');
                    if(pbSelect) pbSelect.innerHTML = (metadata.pricebooks||[]).map(pb => `<option value="${pb.id}">${pb.name}</option>`).join('');
                    
                    if(id) {
                        document.getElementById('input-svc-name').value = data.name;
                        document.getElementById('input-sf-account').value = getMetadataName(metadata.salesforceAccounts, data.sf_account_id) || data.client;
                        document.getElementById('input-ca-client').value = getMetadataName(metadata.contaAzulClients, data.ca_client_id) || '';
                        document.getElementById('input-svc-type').value = data.type || 'Projeto';
                        document.getElementById('input-svc-start').value = data.dataInicio || '';
                        document.getElementById('input-svc-end-orig').value = data.dataFimOriginal || '';
                        document.getElementById('input-svc-end-real').value = data.dataFim || '';

                        document.getElementById('input-lead-project').value = getMetadataName(metadata.people, data.lead_project) || '';
                        document.getElementById('input-coordinator').value = getMetadataName(metadata.people, data.coordinator) || '';
                        document.getElementById('input-tech-lead').value = getMetadataName(metadata.people, data.tech_lead) || '';

                        updateSummaryCards(data.prop?.rev, data.prop?.margin, data.fcst?.rev, data.fcst?.margin, data.act?.rev, data.act?.margin);
                        
                        const docContainer = document.getElementById('docs-list-container');
                        docContainer.innerHTML = '';
                        attachedDocIds = []; 
                        
                        if (data.documents && data.documents.length > 0) {
                            data.documents.forEach(doc => {
                                attachedDocIds.push(doc.docId);
                                docContainer.insertAdjacentHTML('beforeend', `
                                    <div class="flex items-center justify-between p-2 border border-gray-100 rounded mb-1 bg-white" id="doc-${doc.docId}">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-4 h-4 text-indigo-500"></i>
                                            <span class="text-xs font-bold truncate max-w-[200px]" title="${doc.name}">${doc.name}</span>
                                            <a href="/api/services/doc/${doc.docId}" target="_blank" class="text-gray-400 hover:text-blue-600" title="Baixar"><i data-lucide="download" class="w-3 h-3"></i></a>
                                        </div>
                                        <button onclick="deleteDocument('${doc.docId}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>
                                `);
                            });
                        } else {
                            docContainer.innerHTML = '<p class="text-xs text-gray-400 text-center italic">Nenhum documento anexado.</p>';
                        }
                    }
                    
                    // Populate Linked Sales (Inline Rows)
                    document.getElementById('linked-sales-rows').innerHTML = '';
                    if (data.sales && data.sales.length > 0) {
                        data.sales.forEach(s => addSalesRow(s));
                    }

                    // Populate Installments
                    document.getElementById('svc-billing-list').innerHTML = '';
                    if (data.installments && data.installments.length > 0) {
                        data.installments.forEach(i => addBillingRow(i));
                    } else {
                        document.getElementById('svc-billing-list').innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-400 italic">Nenhuma parcela disponível. Vincule vendas para gerar.</td></tr>';
                    }
                    
                    // Trigger async load of options
                    setTimeout(() => loadSalesOptions(), 500);
                    
                    const commRows = document.getElementById('commercial-rows'); 
                    if(commRows) {
                        commRows.innerHTML = '';
                        (data.commercial && data.commercial.length > 0 ? data.commercial : [{}]).forEach(row => addCommercialRow(row));
                    }
                    
                    const execRows = document.getElementById('execution-rows'); 
                    if(execRows) {
                        execRows.innerHTML = '';
                        (data.execution && data.execution.length > 0 ? data.execution : [{}]).forEach(row => addExecutionRow(row));
                    }
                    
                    calculateAllTotals();
                    refreshAllForecasts();
                    document.getElementById('modal-loader').classList.add('hidden');
                    lucide.createIcons();
                }).catch(err => {
                    console.error(err);
                    document.getElementById('modal-loader').classList.add('hidden');
                    alert("Erro ao carregar dados do serviço.");
                });
            }, 50);
        }

        function onPricebookChange() {
            const hasRows = document.querySelectorAll('.comm-row').length > 0;
            if(hasRows && !confirm("Aplicar preços da tabela a todos os itens? Isso substituirá valores manuais.")) {
                return;
            }
            
            const opts = getProductOptions(null);
            document.querySelectorAll('.comm-row select').forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = opts;
                sel.value = currentVal;
                // Se confirmou, atualiza preços
                if(hasRows) onProductChange(sel);
            });
        }

        function addCommercialRow(data = {}) {
            const tbody = document.getElementById('commercial-rows'); const tr = document.createElement('tr');
            tr.className = "comm-row group hover:bg-gray-50"; tr.dataset.id = data.id || `new-${Date.now()}`;
            // Ajuste: value do select é o NOME do produto
            tr.innerHTML = `<td><select class="input-inline font-semibold text-gray-700" onchange="onProductChange(this)">${getProductOptions(data.productName)}</select></td><td><input type="number" step="1" class="input-inline text-right" placeholder="0.00" value="${data.saleRate || ''}" oninput="calcRow(this)"></td><td><input type="number" step="1" class="input-inline text-right" placeholder="0.00" value="${data.costEst || ''}" oninput="calcRow(this)"></td><td><input type="date" class="input-inline text-center" value="${data.start || ''}" onchange="calcRow(this)"></td><td><input type="date" class="input-inline text-center" value="${data.end || ''}" onchange="calcRow(this)"></td><td class="text-center text-xs text-gray-500 cell-days">0</td><td><input type="number" step="1" class="input-inline text-center" value="${data.alloc || 100}" oninput="calcRow(this)"></td><td class="text-right font-bold text-xs pt-2 cell-hours">0h</td><td class="text-right font-bold text-xs pt-2 text-green-700 bg-green-50 cell-rev">R$ 0,00</td><td class="text-right font-bold text-xs pt-2 text-red-600 cell-cost">R$ 0,00</td><td class="text-right font-bold text-xs pt-2 cell-margin">0%</td><td class="text-center"><button class="text-gray-300 hover:text-red-500 group-hover:opacity-100" onclick="deleteCommercialRow(this)"><i data-lucide="trash-2" class="w-3 h-3"></i></button></td>`;
            tbody.appendChild(tr); if(data.productName) calcRow(tr.querySelector('select')); lucide.createIcons();
        }

        function deleteCommercialRow(btn) {
            const tr = btn.closest('tr');
            const id = tr.dataset.id;
            
            if (id && !id.startsWith('new')) {
                if(!confirm("Excluir este item comercial e seus orçamentos permanentemente?")) return;
                
                document.getElementById('modal-loader').classList.remove('hidden');
                fetch(`/api/services/commercial/${id}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        if(data.success) {
                            tr.remove();
                            calculateAllTotals();
                            recalcDistribution();
                            alert('Item comercial excluído.');
                        } else {
                            alert('Erro ao excluir: ' + data.error);
                        }
                    })
                    .catch(err => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        alert('Erro de comunicação.');
                    });
            } else {
                tr.remove();
                calculateAllTotals();
                recalcDistribution();
            }
        }

        function onProductChange(select) {
            // Buscar dados do option selecionado (dataset)
            const opt = select.options[select.selectedIndex];
            if(opt && opt.value) {
                select.closest('tr').cells[1].querySelector('input').value = parseFloat(opt.dataset.price || 0).toFixed(2);
                select.closest('tr').cells[2].querySelector('input').value = parseFloat(opt.dataset.cost || 0).toFixed(2);
                calcRow(select);
            }
        }

        function calcRow(el) {
            const tr = el.closest('tr'); const saleRate = parseFloat(tr.cells[1].querySelector('input').value) || 0; const costRate = parseFloat(tr.cells[2].querySelector('input').value) || 0;
            const start = tr.cells[3].querySelector('input').value; const end = tr.cells[4].querySelector('input').value; const alloc = parseFloat(tr.cells[6].querySelector('input').value) || 0;
            const pid = tr.cells[0].querySelector('select').value;
            // const hoursPerDay = sel.options[sel.selectedIndex] ? (parseFloat(sel.options[sel.selectedIndex].dataset.hours) || 8) : 8; 
            const hoursPerDay = 8; // Simplificando por enquanto

            const days = countBusinessDays(start, end); const totalHours = days * hoursPerDay * (alloc / 100);
            const rev = totalHours * saleRate; const cost = totalHours * costRate;
            tr.querySelector('.cell-days').innerText = days; tr.querySelector('.cell-hours').innerText = totalHours.toFixed(1) + 'h';
            tr.querySelector('.cell-rev').innerText = moneyValue(rev); tr.querySelector('.cell-cost').innerText = moneyValue(cost);
            tr.querySelector('.cell-margin').innerText = calculateMargin(rev, cost) + '%';
            calculateAllTotals(); recalcDistribution(); refreshAllForecasts();
        }

        function addExecutionRow(data = {}) {
            const tbody = document.getElementById('execution-rows'); const tr = document.createElement('tr');
            tr.className = "exec-row group hover:bg-gray-50";
            // FIX: Ensure data-id is set correctly. If data.id exists, use it; otherwise generate a temp ID.
            tr.dataset.id = data.id || `new-${Date.now()}`; 
            
            tr.innerHTML = `<td><select class="input-inline text-xs font-bold text-indigo-700" onfocus="this.innerHTML = getCommLinkOptions(this.value)" onchange="onAllocLinkChange(this)">${getCommLinkOptions(data.commercialLinkId)}</select></td><td><select class="input-inline" onchange="onPersonChange(this)">${getPeopleOptions(data.person)}</select></td><td><input class="input-inline text-right readonly-field" readonly value="${data.saleApplied || '0.00'}"></td><td><input class="input-inline text-right readonly-field" readonly value="${data.costReal || '0.00'}"></td><td><input type="date" class="input-inline text-center" value="${data.start || ''}" onchange="recalcDistribution()"></td><td><input type="date" class="input-inline text-center" value="${data.end || ''}" onchange="recalcDistribution()"></td><td><input type="number" class="input-inline text-center" value="${data.alloc || 100}" oninput="recalcDistribution()"></td><td class="text-center text-xs text-gray-500 cell-days">0</td><td class="text-right font-bold text-xs pt-2 cell-hours">0h</td><td class="text-right font-bold text-xs pt-2 text-green-700 bg-green-50 cell-rev">R$ 0,00</td><td class="text-right font-bold text-xs pt-2 text-red-600 cell-cost">R$ 0,00</td><td class="text-right font-bold text-xs pt-2 cell-margin">0%</td><td class="text-center"><button class="text-gray-300 hover:text-red-500 group-hover:opacity-100" onclick="deleteAllocationRow(this)"><i data-lucide="trash-2" class="w-3 h-3"></i></button></td>`;
            tbody.appendChild(tr); if(data.person) onPersonChange(tr.cells[1].querySelector('select')); lucide.createIcons();
        }

        function deleteAllocationRow(btn) {
            console.log("deleteAllocationRow called"); // Debug
            const tr = btn.closest('tr');
            const id = tr.dataset.id;
            console.log("Allocation ID:", id); // Debug
            
            if (id && !id.startsWith('new')) {
                if(!confirm("Excluir esta alocação permanentemente?")) return;
                
                console.log("Sending DELETE request..."); // Debug
                document.getElementById('modal-loader').classList.remove('hidden');
                fetch(`/api/services/allocation/${id}`, { method: 'DELETE' })
                    .then(res => {
                        console.log("Response Status:", res.status); // Debug
                        return res.json();
                    })
                    .then(data => {
                        console.log("Response Data:", data); // Debug
                        document.getElementById('modal-loader').classList.add('hidden');
                        if(data.success) {
                            tr.remove();
                            recalcDistribution();
                            // showToast('Sucesso', 'Alocação excluída.'); // showToast removed due to DOM errors
                            alert('Alocação excluída.');
                        } else {
                            alert('Erro ao excluir: ' + data.error);
                        }
                    })
                    .catch(err => {
                        console.error("Fetch Error:", err); // Debug
                        document.getElementById('modal-loader').classList.add('hidden');
                        alert('Erro de comunicação.');
                    });
            } else {
                console.log("Removing unsaved row"); // Debug
                tr.remove();
                recalcDistribution();
            }
        }

        function onPersonChange(select) { select.closest('tr').cells[3].querySelector('input').value = select.selectedOptions[0].dataset.cost || 0; recalcDistribution(); }
        function onAllocLinkChange(select) { recalcDistribution(); }

        function openUploadModal() { 
            document.getElementById('file-input').value = '';
            document.getElementById('upload-modal').classList.remove('hidden'); 
        }

        function uploadFile() { 
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const type = document.getElementById('doc-type-select').value;
            const container = document.getElementById('docs-list-container');
            
            if(file) {
                const formData = new FormData();
                formData.append('files', file); 
                formData.append('type', type);

                document.getElementById('modal-loader').classList.remove('hidden');
                document.getElementById('upload-modal').classList.add('hidden');

                fetch('/api/services/doc', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        if(container.innerText.includes('Nenhum')) container.innerHTML='';
                        const docId = data.docId;
                        attachedDocIds.push(docId);
                        container.insertAdjacentHTML('beforeend', `
                            <div class="flex items-center justify-between p-2 border border-gray-100 rounded mb-1 bg-white" id="doc-${docId}">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-4 h-4 text-indigo-500"></i>
                                    <span class="text-xs font-bold truncate max-w-[200px]" title="${file.name}">${file.name}</span>
                                    <a href="/api/services/doc/${docId}" target="_blank" class="text-gray-400 hover:text-blue-600" title="Baixar"><i data-lucide="download" class="w-3 h-3"></i></a>
                                </div>
                                <button onclick="deleteDocument('${docId}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        `);
                        fileInput.value = ''; lucide.createIcons();
                        showToast('Sucesso', 'Arquivo anexado.');
                    } else { showToast('Erro', data.message, 'red'); }
                })
                .catch(err => { console.error(err); showToast('Erro', 'Erro no upload.', 'red'); })
                .finally(() => { document.getElementById('modal-loader').classList.add('hidden'); });
            }
        }

        function addBillingRow(d={}) { 
            const t=document.getElementById('svc-billing-list'); 
            if(t.innerText.includes('Nenhuma parcela')) t.innerHTML = '';
            const r=t.children.length+1; 
            
            // Normalize and debug
            const statusVal = (d.status || '').trim();
            const statusUpper = statusVal.toUpperCase();
            console.log(`[addBillingRow] Status: "${statusVal}" -> Upper: "${statusUpper}"`);

            let statusClass = 'bg-yellow-100 text-yellow-700';
            if (['PAGO', 'QUITADO', 'APROVADO', 'CONFIRMADO'].includes(statusUpper)) statusClass = 'bg-green-100 text-green-700';
            else if (statusUpper === 'ATRASADO' || statusUpper === 'VENCIDO') statusClass = 'bg-red-100 text-red-700';
            else if (statusUpper === 'CANCELADO') statusClass = 'bg-gray-100 text-gray-700';
            
            const tr = document.createElement('tr');
            tr.className = "group hover:bg-gray-50 installment-row";
            if (d.originSaleId) tr.dataset.originSaleId = d.originSaleId;
            if (d.id) tr.dataset.id = d.id;

            // Formatação do valor (Moeda BRL)
            const formattedValue = d.value ? parseFloat(d.value).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '';
            
            // Campos readonly se vierem do ERP
            const isReadonly = d.originSaleId ? 'readonly tabindex="-1"' : '';
            const readonlyClass = d.originSaleId ? 'bg-gray-50 text-gray-500 cursor-not-allowed border-transparent' : 'font-bold text-gray-800';

            tr.innerHTML = `
                <td class="px-4 py-3 text-center text-gray-400 font-medium">${r}</td>
                <td class="px-4 py-3">
                    <input class="input-inline font-semibold text-gray-700 ${d.originSaleId ? 'bg-gray-50' : ''}" value="${d.desc||''}" placeholder="Descrição" ${isReadonly}>
                </td>
                <td class="px-4 py-3 text-center">
                    <input class="input-inline text-center ${d.originSaleId ? 'bg-gray-50' : ''}" type="month" value="${d.month||''}" ${isReadonly}>
                </td>
                <td class="px-4 py-3 text-center">
                    <input class="input-inline text-center ${d.originSaleId ? 'bg-gray-50' : ''}" type="date" value="${d.date||''}" ${isReadonly}>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="sale-status px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${statusClass}">${d.status || 'Pendente'}</span>
                </td>
                <td class="px-4 py-3 text-right">
                    <input class="input-inline text-right ${readonlyClass}" type="text" 
                           value="${formattedValue}" placeholder="0,00" oninput="calcInstallmentsTotal()" ${isReadonly}>
                </td>
                <td class="px-4 py-3 text-center">
                    ${!d.originSaleId ? 
                        `<button onclick="deleteInstallmentRow(this)" class="text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : 
                        `<i data-lucide="lock" class="w-3 h-3 text-gray-300 mx-auto"></i>`
                    }
                </td>
            `; 
            t.appendChild(tr);
            lucide.createIcons(); 
            calcInstallmentsTotal();
        }

        function calcInstallmentsTotal() {
            let total = 0;
            document.querySelectorAll('.installment-row').forEach(tr => {
                const input = tr.querySelectorAll('input')[3]; // O campo de valor
                // Converter "1.234,56" para 1234.56
                const valStr = input.value.replace(/\./g, '').replace(',', '.');
                total += parseFloat(valStr || 0);
            });
            document.getElementById('total-installments').innerText = moneyValue(total);
        }

        // --- LINKED SALES FUNCTIONS (INLINE) ---
        let availableSalesMap = {}; 

        async function loadSalesOptions(force = false) {
            const caClientId = document.querySelector('#ca-clients-list option[value="' + document.getElementById('input-ca-client').value + '"]')?.dataset.id 
                             || document.getElementById('input-ca-client').value;
            const datalist = document.getElementById('available-sales-list');
            
            // Se já carregado e não for forçado, não busca de novo
            if (Object.keys(availableSalesMap).length > 0 && !force) return;
            
            if (!caClientId || caClientId.length < 5) return; 

            // Feedback visual de carregamento nos inputs
            const inputs = document.querySelectorAll('.sale-search-input:not([readonly])');
            const loaders = document.querySelectorAll('.sale-loader');
            inputs.forEach(i => i.placeholder = "Carregando vendas...");
            loaders.forEach(l => l.classList.remove('hidden'));

            try {
                const res = await fetch(`/api/services/sales/available?caClientId=${caClientId}`);
                const sales = await res.json();
                
                datalist.innerHTML = '';
                availableSalesMap = {};
                sales.forEach(s => {
                    const label = `Venda #${s.number} - ${moneyValue(s.total)}`;
                    availableSalesMap[label] = s;
                    datalist.insertAdjacentHTML('beforeend', `<option value="${label}">Venda: ${new Date(s.emissionDate).toLocaleDateString('pt-BR')} | Status: ${s.status}</option>`);
                });
            } catch (e) { 
                console.error("Erro ao carregar vendas:", e); 
            } finally {
                inputs.forEach(i => i.placeholder = "Buscar venda...");
                loaders.forEach(l => l.classList.add('hidden'));
            }
        }

        async function addSalesRow(data = {}) {
            const tbody = document.getElementById('linked-sales-rows');
            const tr = document.createElement('tr');
            tr.className = "sale-row group hover:bg-gray-50";
            tr.dataset.id = data.id || `new-${Date.now()}`; // Store SF ID
            
            // Se for uma nova linha manual, força a carga/atualização das opções
            if(!data.id_ca) await loadSalesOptions(true);
            // Se for carga inicial (vindo do banco), carrega apenas se necessário (cache)
            else if (Object.keys(availableSalesMap).length === 0) await loadSalesOptions();

            const inputValue = data.number ? `Venda #${data.number} - ${moneyValue(data.total)}` : '';
            if(data.id_ca && data.number) {
                 availableSalesMap[inputValue] = { id: data.id_ca, number: data.number, emissionDate: data.date, total: data.total, status: data.status };
            }

            // Bloquear edição se já estiver salvo no SF
            const isSaved = data.id && !data.id.startsWith('new');
            const readonlyAttr = isSaved ? 'readonly' : '';
            const bgClass = isSaved ? 'bg-gray-100 cursor-not-allowed' : 'bg-gray-50';

            // Normalize and debug
            const statusVal = (data.status || '').trim();
            const statusUpper = statusVal.toUpperCase();
            console.log(`[addSalesRow] Status: "${statusVal}" -> Upper: "${statusUpper}"`);

            let statusClass = 'bg-yellow-100 text-yellow-700';
            if (['APROVADO', 'EM_ANDAMENTO', 'FINALIZADO', 'CONCLUIDO'].includes(statusUpper)) statusClass = 'bg-green-100 text-green-700';
            else if (statusUpper === 'CANCELADO' || statusUpper === 'REPROVADO') statusClass = 'bg-red-100 text-red-700';
            else if (statusUpper === 'RASCUNHO' || statusUpper === 'PENDENTE') statusClass = 'bg-yellow-100 text-yellow-700';

            tr.innerHTML = `
                <td class="px-4 py-2">
                    <div class="relative flex items-center">
                        <input list="available-sales-list" class="sale-search-input w-full border border-gray-200 rounded pl-2 pr-8 py-1.5 text-xs font-bold text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 ${bgClass}" 
                               placeholder="Buscar venda..." 
                               value="${inputValue}"
                               onchange="onSaleChange(this)" onfocus="loadSalesOptions()" ${readonlyAttr}>
                        
                        <div class="sale-loader absolute right-12 hidden">
                            <div class="w-3 h-3 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        </div>

                        ${!isSaved ? 
                            `<button onclick="clearSaleInput(this)" class="absolute right-7 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''
                        }
                        <input type="hidden" class="sale-id-ca" value="${data.id_ca || ''}">
                    </div>
                </td>
                <td class="px-4 py-2 text-center text-gray-500 text-xs sale-date">${data.date ? new Date(data.date).toLocaleDateString('pt-BR') : '-'}</td>
                <td class="px-4 py-2 text-center">
                    <span class="sale-status px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${statusClass}">
                        ${statusVal || '-'}
                    </span>
                </td>
                <td class="px-4 py-2 text-right font-bold text-gray-800 sale-total">${moneyValue(data.total)}</td>
                <td class="px-4 py-2 text-center">
                    <button onclick="removeSalesRow(this)" class="text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
            lucide.createIcons();
            calcSalesTotal();
        }

        function clearSaleInput(btn) {
            const container = btn.parentElement;
            const input = container.querySelector('input[list]');
            input.value = '';
            onSaleChange(input); // Trigger cleanup
            input.focus();
        }

        async function onSaleChange(input) {
            const val = input.value;
            const data = availableSalesMap[val];
            const tr = input.closest('tr');
            const oldIdCa = tr.querySelector('.sale-id-ca').value;

            if (data) {
                // VERIFICAÇÃO DE DUPLICIDADE:
                const isDuplicate = Array.from(document.querySelectorAll('.sale-id-ca')).some(el => {
                    return el !== tr.querySelector('.sale-id-ca') && el.value === data.id;
                });

                if (isDuplicate) {
                    alert('Esta venda já está vinculada a este serviço.');
                    input.value = '';
                    return onSaleChange(input); // Limpa a linha
                }

                if (oldIdCa === data.id) return; // No change

                tr.querySelector('.sale-id-ca').value = data.id;
                tr.querySelector('.sale-date').innerText = new Date(data.emissionDate).toLocaleDateString('pt-BR');
                
                const statusSpan = tr.querySelector('.sale-status');
                const sUpper = (data.status || '').toUpperCase();
                let sClass = 'bg-yellow-100 text-yellow-700';
                if (['APROVADO', 'EM ANDAMENTO', 'EM_ANDAMENTO', 'FINALIZADO', 'CONCLUIDO'].includes(sUpper)) sClass = 'bg-green-100 text-green-700';
                else if (sUpper === 'CANCELADO' || sUpper === 'REPROVADO') sClass = 'bg-red-100 text-red-700';

                statusSpan.innerText = data.status;
                statusSpan.className = `sale-status px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${sClass}`;
                
                tr.querySelector('.sale-total').innerText = moneyValue(data.total);

                // Fetch and add installments preview
                try {
                    document.getElementById('modal-loader').classList.remove('hidden');
                    const res = await fetch(`/api/services/sales/${data.id}/installments`);
                    const insts = await res.json();
                    
                    // Se estiver trocando a venda nesta linha, remove as parcelas da venda anterior
                    if(oldIdCa) {
                        document.querySelectorAll(`.installment-row[data-origin-sale-id="${oldIdCa}"]`).forEach(el => el.remove());
                    }

                    insts.forEach(i => {
                        addBillingRow({ ...i, originSaleId: data.id });
                    });
                } catch (e) {
                    console.error("Erro ao buscar parcelas:", e);
                } finally {
                    document.getElementById('modal-loader').classList.add('hidden');
                }
            } else {
                // Limpar se inválido e remover parcelas associadas
                if(oldIdCa) {
                    document.querySelectorAll(`.installment-row[data-origin-sale-id="${oldIdCa}"]`).forEach(el => el.remove());
                }
                tr.querySelector('.sale-id-ca').value = '';
                tr.querySelector('.sale-date').innerText = '-';
                tr.querySelector('.sale-status').innerText = '-';
                tr.querySelector('.sale-total').innerText = 'R$ 0,00';
            }
            calcSalesTotal();
        }

        function removeSalesRow(btn) {
            const tr = btn.closest('tr');
            const sfId = tr.dataset.id;
            const idCa = tr.querySelector('.sale-id-ca').value;

            const performRemoval = () => {
                // Remove associated installments from DOM
                if(idCa) {
                    document.querySelectorAll(`.installment-row[data-origin-sale-id="${idCa}"]`).forEach(el => el.remove());
                }
                tr.remove();
                calcSalesTotal();
                loadSalesOptions(true); 
            };

            if (sfId && !sfId.startsWith('new')) {
                if(!confirm("Desvincular esta venda e suas parcelas?")) return;
                
                document.getElementById('modal-loader').classList.remove('hidden');
                fetch(`/api/services/sales/${sfId}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        if(data.success) {
                            performRemoval();
                            alert('Venda desvinculada.');
                        } else {
                            alert('Erro ao desvincular: ' + data.error);
                        }
                    })
                    .catch(err => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        alert('Erro de comunicação.');
                    });
            } else {
                performRemoval();
            }
        }

        function calcSalesTotal() {
            let total = 0;
            document.querySelectorAll('.sale-row').forEach(tr => {
                const valStr = tr.querySelector('.sale-total').innerText;
                total += parseFloat(valStr.replace(/[^0-9,-]+/g,"").replace(",",".") || 0);
            });
            document.getElementById('total-linked-sales').innerText = moneyValue(total);
        }

        function deleteInstallmentRow(btn) {
            const tr = btn.closest('tr');
            const id = tr.dataset.id;
            
            if (id && !id.startsWith('new')) {
                if(!confirm("Excluir esta parcela permanentemente?")) return;
                
                document.getElementById('modal-loader').classList.remove('hidden');
                fetch(`/api/services/installments/${id}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        if(data.success) {
                            tr.remove();
                            calcInstallmentsTotal();
                            alert('Parcela excluída.');
                        } else {
                            alert('Erro ao excluir: ' + data.error);
                        }
                    })
                    .catch(err => {
                        document.getElementById('modal-loader').classList.add('hidden');
                        alert('Erro de comunicação.');
                    });
            } else {
                tr.remove();
                calcInstallmentsTotal();
            }
        }

        function removeRow(btn) { 
            btn.closest('tr').remove(); 
            recalcDistribution(); 
            calcInstallmentsTotal(); 
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function switchTab(t) { ['general','commercial','execution','financial','billing','realized'].forEach(x => { document.getElementById(`view-${x}`).classList.add('hidden'); document.getElementById(`tab-${x}`).className = 'modal-tab-inactive px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap'; }); document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).className = 'modal-tab-active px-6 py-3 text-xs uppercase font-bold tracking-wide transition-colors whitespace-nowrap'; }
        
        function saveService(integrate) {
            if (!currentServiceData) return;

            const getDatalistId = (inputId, listId) => {
                const val = document.getElementById(inputId).value;
                const opt = document.querySelector(`#${listId} option[value="${val}"]`);
                return opt ? opt.dataset.id : val; 
            };

            const startDate = document.getElementById('input-svc-start').value;
            const endDateOrig = document.getElementById('input-svc-end-orig').value;
            const endDateReal = document.getElementById('input-svc-end-real').value;

            // Coletar itens comerciais
            const commercial = [];
            document.querySelectorAll('.comm-row').forEach(tr => {
                const sel = tr.cells[0].querySelector('select');
                if (sel.value) {
                    // Recalcula totais para garantir precisão
                    const saleRate = parseFloat(tr.cells[1].querySelector('input').value) || 0;
                    const costRate = parseFloat(tr.cells[2].querySelector('input').value) || 0;
                    const hoursStr = tr.querySelector('.cell-hours').innerText.replace('h','');
                    const totalHours = parseFloat(hoursStr) || 0;
                    const totalRev = totalHours * saleRate;
                    const totalCost = totalHours * costRate;

                    commercial.push({
                        id: tr.dataset.id, 
                        productId: null, 
                        productName: sel.value,
                        saleRate: saleRate,
                        costEst: costRate,
                        start: tr.cells[3].querySelector('input').value || startDate, 
                        end: tr.cells[4].querySelector('input').value || endDateOrig, 
                        alloc: parseFloat(tr.cells[6].querySelector('input').value) || 0,
                        totalRev: totalRev,
                        totalCost: totalCost,
                        totalHours: totalHours,
                        monthlyData: getItemMonthlyData(tr) // Nova função
                    });
                }
            });

            const execution = [];
            document.querySelectorAll('.exec-row').forEach(tr => {
                const selComm = tr.cells[0].querySelector('select');
                const selPerson = tr.cells[1].querySelector('select');
                if (selPerson.value) {
                     const opt = selPerson.selectedOptions[0];
                     const personId = opt ? opt.dataset.id : null;
                     
                     // Capture calculated values from DOM/Dataset
                     const saleRate = parseFloat(tr.cells[2].querySelector('input').value) || 0;
                     const costRate = parseFloat(tr.cells[3].querySelector('input').value) || 0;
                     const days = parseInt(tr.querySelector('.cell-days').innerText) || 0;
                     const totalHours = parseFloat(tr.querySelector('.cell-hours').innerText.replace('h','')) || 0;
                     const totalRev = parseFloat(tr.querySelector('.cell-rev').innerText.replace(/[^0-9,-]+/g,"").replace(",",".") || 0);
                     const totalCost = parseFloat(tr.querySelector('.cell-cost').innerText.replace(/[^0-9,-]+/g,"").replace(",",".") || 0);
                     const marginStr = tr.querySelector('.cell-margin').innerText.replace('%','');
                     const margin = parseFloat(marginStr) || 0;

                     execution.push({
                        id: tr.dataset.id, 
                        personId: personId,
                        commercialLinkId: selComm.value || null,
                        start: tr.cells[4].querySelector('input').value || startDate,
                        end: tr.cells[5].querySelector('input').value || endDateOrig,
                        alloc: parseFloat(tr.cells[6].querySelector('input').value) || 0,
                        
                        // New fields
                        saleRate: saleRate,
                        costRate: costRate,
                        days: days,
                        totalHours: totalHours,
                        totalRev: totalRev,
                        totalCost: totalCost,
                        margin: margin,
                        
                        monthlyData: getExecutionMonthlyData(tr)
                     });
                }
            });

            // Capture Selected Sales (From Inline Rows)
            const salesPayload = [];
            document.querySelectorAll('.sale-row').forEach(tr => {
                const idCa = tr.querySelector('.sale-id-ca').value;
                if(idCa) {
                    const totalStr = tr.querySelector('.sale-total').innerText.replace(/[^0-9,-]+/g,"").replace(",",".");
                    const dateStr = tr.querySelector('.sale-date').innerText;
                    let emissionDate = null;
                    if(dateStr && dateStr !== '-') {
                        const parts = dateStr.split('/');
                        if(parts.length === 3) emissionDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    salesPayload.push({
                        id: idCa,
                        number: tr.querySelector('input[list]').value.match(/#(\d+)/)?.[1] || 'S/N',
                        emissionDate: emissionDate,
                        total: parseFloat(totalStr) || 0,
                        status: tr.querySelector('.sale-status').innerText
                    });
                }
            });

            // Capture Installments
            const installmentsPayload = [];
            document.querySelectorAll('.installment-row').forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                const valStr = inputs[3].value.replace(/\./g, '').replace(',', '.');
                installmentsPayload.push({
                    id: tr.dataset.id || null,
                    desc: inputs[0].value,
                    month: inputs[1].value,
                    date: inputs[2].value,
                    status: tr.querySelector('.sale-status')?.innerText.trim() || 'Pendente',
                    value: parseFloat(valStr) || 0,
                    originSaleId: tr.dataset.originSaleId
                });
            });

            const payload = {
                id: currentServiceData.id,
                name: document.getElementById('input-svc-name').value,
                sf_account_id: getDatalistId('input-sf-account', 'sf-accounts-list'),
                ca_client_id: getDatalistId('input-ca-client', 'ca-clients-list'),
                type: document.getElementById('input-svc-type').value,
                lead_project: getDatalistId('input-lead-project', 'people-list'),
                coordinator: getDatalistId('input-coordinator', 'people-list'),
                tech_lead: getDatalistId('input-tech-lead', 'people-list'),
                start: startDate,
                end_original: endDateOrig,
                end_real: endDateReal,
                integrate: integrate,
                docIds: attachedDocIds,
                commercial: commercial,
                execution: execution,
                selectedSales: salesPayload,
                installments: installmentsPayload // NEW
            };

            if (!payload.name || !payload.sf_account_id || !payload.start) {
                alert('Erro: Campos obrigatórios: Nome, Cliente e Data Início.');
                return;
            }

            document.getElementById('modal-loader').classList.remove('hidden');

            fetch('/api/services', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('modal-loader').classList.add('hidden');
                if (data.success) {
                    // Após salvar o serviço com sucesso, vincular as vendas e salvar parcelas
                    if (salesPayload.length > 0 || installmentsPayload.length > 0) {
                        fetch('/api/services/sales', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                serviceId: data.id, 
                                sales: salesPayload,
                                installments: installmentsPayload // Incluindo parcelas
                            })
                        }).then(() => {
                            alert('Sucesso: Serviço salvo e vendas vinculadas!');
                            closeModal('service-modal');
                            filterServices();
                        });
                    } else {
                        alert('Sucesso: ' + data.message);
                        closeModal('service-modal');
                        filterServices();
                    }
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(err => {
                document.getElementById('modal-loader').classList.add('hidden');
                console.error(err);
                alert('Erro: Falha na comunicação.');
            });
        }
        
        // Função showToast removida para evitar erros de DOM.
        console.log("Services App Loaded v2");
        renderServices();
    </script>
</body>
</html>