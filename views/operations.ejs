<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Operações - C3C Workplace</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: { c3c: { blue: '#2978FF', teal: '#1DDDBD', bg: '#F8FAFC' } }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #F8FAFC; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .tab-active { border-bottom: 2px solid #2978FF; color: #2978FF; font-weight: 700; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #6B7280; font-weight: 500; }
        .timer-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
            100% { text-shadow: 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-c3c-bg">

    <%- include('partials/sidebar') %>

    <main class="flex-1 flex flex-col relative w-full overflow-hidden md:pl-64 transition-all duration-300">
        
        <header class="h-16 md:h-20 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>
                    Operação N2
                </h1>
                
                <div class="hidden md:flex items-center bg-gray-100 rounded-full px-4 py-1.5 border border-gray-200 ml-4">
                    <div class="text-xl font-mono font-bold text-gray-600 mr-3 w-24 text-center" id="global-timer">00:00:00</div>
                    <div class="flex gap-1">
                        <button id="global-play" onclick="startGlobalTimer()" class="p-1.5 bg-green-500 hover:bg-green-600 text-white rounded-full transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Selecione um chamado primeiro">
                            <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                        </button>
                        <button id="global-stop" onclick="stopGlobalTimer()" class="hidden p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full transition-transform active:scale-95">
                            <i data-lucide="square" class="w-3 h-3 fill-current"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-lg border border-gray-200">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs text-gray-700 font-bold">Disponível</span>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            
            <div class="w-full md:w-[400px] flex flex-col border-r border-gray-200 bg-white" id="ticket-list-panel">
                
                <div class="p-3 border-b border-gray-200 bg-white flex flex-col gap-3">
                    <button onclick="openModal('new-ticket-modal')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2.5 rounded-lg flex items-center justify-center gap-2 shadow-sm transition-all active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Novo Chamado
                    </button>
                    
                    <div class="flex border-b border-gray-200">
                        <button onclick="changeFilter('my')" id="tab-my" class="flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50">Meus</button>
                        <button onclick="changeFilter('queue')" id="tab-queue" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">Fila</button>
                        <button onclick="changeFilter('team')" id="tab-team" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">Equipe</button>
                    </div>
                </div>

                <div id="tickets-list-container" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/30">
                    <p class="text-center text-xs text-gray-400 mt-5">Carregando...</p>
                </div>
            </div>

            <div class="hidden md:flex flex-1 bg-white flex-col relative w-full" id="ticket-workspace">
                
                <div class="md:hidden p-2 bg-gray-50 border-b border-gray-200">
                    <button onclick="closeTicketMobile()" class="text-sm text-gray-600 flex items-center gap-1 font-bold"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                </div>

                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 text-gray-400 z-0">
                    <i data-lucide="mouse-pointer-2" class="w-16 h-16 mb-4 text-gray-300"></i>
                    <p class="text-sm font-medium">Selecione um chamado para iniciar.</p>
                </div>

                <div id="ticket-panel" class="flex-1 flex flex-col h-full hidden z-10 bg-white w-full">
                    
                    <div class="px-6 py-4 border-b border-gray-200 bg-white flex flex-col md:flex-row justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-3 mb-1">
                                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-mono font-bold" id="detail-number">#</span>
                                <span class="text-xs text-indigo-600 font-bold uppercase tracking-wider" id="detail-client">CLIENTE</span>
                            </div>
                            <h1 class="text-xl font-bold text-gray-900 mt-1" id="detail-title">Titulo</h1>
                        </div>
                        <div class="flex gap-2 shrink-0" id="header-actions"></div>
                    </div>

                    <div class="px-6 pt-2 border-b border-gray-200 bg-gray-50/50 flex gap-6 overflow-x-auto">
                        <button onclick="switchDetailTab('info')" id="dt-info" class="pb-3 text-sm tab-active whitespace-nowrap">Informações</button>
                        <button onclick="switchDetailTab('logs')" id="dt-logs" class="pb-3 text-sm tab-inactive whitespace-nowrap">Histórico & Tempos</button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                        <div id="view-info" class="space-y-6">
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Descrição</h3>
                                <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line" id="detail-desc">...</p>
                            </div>
                            
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Comentários</h3>
                                <div id="comments-list" class="space-y-3 mb-3"></div>
                                <div class="flex gap-2" id="comment-box">
                                    <input type="text" id="quick-comment" placeholder="Adicionar comentário..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <button onclick="postComment()" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"><i data-lucide="send" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>

                        <div id="view-logs" class="hidden h-full flex flex-col">
                            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex-1">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2">Data</th>
                                            <th class="px-4 py-2">Tipo</th>
                                            <th class="px-4 py-2">Atividade / Descrição</th>
                                            <th class="px-4 py-2 text-right">Horas</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100" id="logs-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="time-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4 text-indigo-600"></i> Lançar Horas
            </h3>
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">Data</label>
                <input type="date" id="modal-date" class="w-full border border-gray-300 rounded p-2 text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">Atividade</label>
                <select id="modal-activity-select" onchange="toggleNewActivityInput()" class="w-full border border-gray-300 rounded p-2 text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"></select>
                
                <input type="text" id="modal-new-activity-name" class="w-full border border-indigo-300 rounded p-2 text-sm mt-2 hidden bg-indigo-50 focus:ring-2 focus:ring-indigo-500" placeholder="Nome da nova atividade">
                <p class="text-[10px] text-gray-400 mt-1 hidden" id="modal-activity-hint">
                    Será salvo como: <span id="case-prefix" class="font-bold"></span> - [Nome]
                </p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Duração (h)</label>
                    <input type="number" step="0.5" min="0.5" id="modal-hours" class="w-full border border-gray-300 rounded p-2 text-lg font-mono text-center font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0.5">
                    <p class="text-[9px] text-gray-400 text-center mt-1">Múltiplos de 0.5</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label>
                    <select id="modal-type" class="w-full border border-gray-300 rounded p-2 text-sm bg-white h-[46px] outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="normal">Normal</option>
                        <option value="extra" class="text-red-600 font-bold">Hora Extra</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">Justificativa</label>
                <input type="text" id="modal-desc" class="w-full border border-gray-300 rounded p-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeModal('time-modal')" class="px-4 py-2 text-gray-500 font-bold text-xs hover:bg-gray-100 rounded">Cancelar</button>
                <button onclick="saveLog()" class="px-4 py-2 bg-indigo-600 text-white font-bold text-xs rounded hover:bg-indigo-700 shadow-md">Salvar</button>
            </div>
        </div>
    </div>

    <div id="new-ticket-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4 text-indigo-600"></i> Novo Chamado
                </h3>
                <button onclick="closeModal('new-ticket-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-1">Cliente (Nome da Conta)</label>
                    <input type="text" id="new-client-name" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Ex: Tech Solutions">
                    <p class="text-[10px] text-gray-400 mt-1">O sistema buscará a conta pelo nome.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-1">Assunto</label>
                    <input type="text" id="new-subject" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-1">Descrição</label>
                    <textarea id="new-desc" class="w-full border border-gray-300 rounded p-2 text-sm h-24 resize-none focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal('new-ticket-modal')" class="px-4 py-2 text-gray-600 font-bold text-xs hover:bg-gray-100 rounded">Cancelar</button>
                    <button onclick="createTicket()" class="px-4 py-2 bg-indigo-600 text-white font-bold text-xs rounded hover:bg-indigo-700 shadow-md">Criar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // Estado Global
        let activeTicketId = null;
        let ticketsCache = [];
        let currentFilter = 'my';
        let globalSeconds = 0;
        let globalInterval = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => { changeFilter('my'); });

        // --- LÓGICA DE LISTA E FILTROS ---
        async function changeFilter(type) {
            currentFilter = type;
            ['my','queue','team'].forEach(t => {
                const b = document.getElementById(`tab-${t}`);
                if(t===type) { 
                    b.classList.add('text-indigo-600','border-indigo-600','bg-indigo-50/50'); 
                    b.classList.remove('text-gray-500','border-transparent'); 
                } else { 
                    b.classList.remove('text-indigo-600','border-indigo-600','bg-indigo-50/50'); 
                    b.classList.add('text-gray-500','border-transparent'); 
                }
            });

            const list = document.getElementById('tickets-list-container');
            list.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Carregando...</p>';
            
            try {
                const res = await fetch(`/api/ops/tickets?filter=${type}`);
                const data = await res.json();
                ticketsCache = data;
                renderList(data);
            } catch(e) { list.innerHTML = '<p class="text-center text-xs text-red-400">Erro ao carregar lista.</p>'; }
        }

        function renderList(data) {
            const list = document.getElementById('tickets-list-container');
            list.innerHTML = '';
            if(data.length === 0) return list.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Nenhum chamado encontrado.</p>';
            
            data.forEach(t => {
                let badge = t.status === 'New' ? 'bg-blue-100 text-blue-700' : (t.status === 'In Progress' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600');
                
                list.innerHTML += `
                <div onclick="loadTicketDetails('${t.id}')" class="ticket-card p-3 border border-gray-200 rounded mb-2 cursor-pointer hover:bg-indigo-50 bg-white transition-all">
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-xs text-gray-600">${t.caseNumber}</span>
                        <span class="text-[10px] ${badge} px-1.5 rounded">${t.status}</span>
                    </div>
                    <div class="text-sm font-bold text-gray-800 truncate">${t.title}</div>
                    <div class="text-xs text-gray-500 flex justify-between mt-1">
                        <span>${t.client}</span>
                        <span>${t.date}</span>
                    </div>
                </div>`;
            });
        }

        // --- LÓGICA DE DETALHES ---
        async function loadTicketDetails(id) {
            activeTicketId = id;
            document.getElementById('ticket-panel').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            // Preenche dados do cache enquanto carrega detalhes
            const t = ticketsCache.find(x => x.id === id) || {};
            document.getElementById('detail-number').innerText = t.caseNumber || '#';
            document.getElementById('detail-client').innerText = t.client || '...';
            document.getElementById('detail-title').innerText = t.title || '...';
            document.getElementById('detail-desc').innerText = t.desc || '...';
            
            // Para exibição no modal
            document.getElementById('case-prefix').innerText = t.caseNumber;

            setupActions();
            switchDetailTab('info');

            const res = await fetch(`/api/ops/tickets/${id}/details`);
            const det = await res.json();
            renderLogs(det.logs);
            renderComments(det.comments);
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';
            if(!logs || logs.length === 0) return tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-xs text-gray-400">Sem apontamentos.</td></tr>';
            
            logs.forEach(l => {
                const badge = l.type === 'Extra' 
                    ? '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold">EXTRA</span>'
                    : '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold">NORMAL</span>';
                
                tbody.innerHTML += `
                <tr class="border-b last:border-0 hover:bg-gray-50">
                    <td class="px-4 py-2 text-xs text-gray-500">${l.date}</td>
                    <td class="px-4 py-2">${badge}</td>
                    <td class="px-4 py-2 text-xs text-gray-700 truncate max-w-[200px]" title="${l.desc}">
                        <span class="font-bold block text-indigo-900">${l.activity}</span>${l.desc}
                    </td>
                    <td class="px-4 py-2 text-right font-mono text-xs font-bold text-indigo-600">${parseFloat(l.hours).toFixed(1)}h</td>
                </tr>`;
            });
        }

        function renderComments(comments) {
            const cList = document.getElementById('comments-list');
            cList.innerHTML = '';
            if (!comments || comments.length === 0) return cList.innerHTML = '<p class="text-xs text-gray-400">Sem comentários.</p>';
            
            comments.forEach(c => {
                cList.innerHTML += `<div class="bg-gray-50 p-2 rounded text-xs border border-gray-100">
                    <span class="font-bold text-gray-700">${c.user}</span> 
                    <span class="text-gray-400 text-[10px] ml-1">${c.time}</span>
                    <p class="mt-1 text-gray-600">${c.text}</p>
                </div>`;
            });
        }

        // --- AÇÕES CONTEXTUAIS ---
        function setupActions() {
            const acts = document.getElementById('header-actions');
            let btns = '';
            
            if(currentFilter === 'queue') {
                btns = `<button onclick="assignTicket()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700 flex gap-1"><i data-lucide="download" class="w-3 h-3"></i> Puxar</button>`;
            } else if (currentFilter === 'my') {
                btns = `
                <button onclick="openLogModal(false)" class="bg-white border text-gray-700 px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-50 shadow-sm">Lançar</button>
                <button onclick="startGlobalTimer()" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700 shadow-sm flex gap-1"><i data-lucide="play" class="w-3 h-3 mt-0.5"></i> Timer</button>
                `;
            } else {
                 btns = `<button onclick="openLogModal(false)" class="bg-white border text-gray-700 px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-50">Apoio</button>`;
            }
            acts.innerHTML = btns;
            lucide.createIcons();
        }

        // --- TIMER & MODAL DE HORAS ---
        function startGlobalTimer() {
            if(!activeTicketId) return alert("Selecione um chamado.");
            if(globalInterval) return;
            
            document.getElementById('global-play').classList.add('hidden');
            document.getElementById('global-stop').classList.remove('hidden');
            document.getElementById('global-timer').classList.add('text-red-600', 'timer-pulse');
            
            globalInterval = setInterval(() => {
                globalSeconds++;
                const h = Math.floor(globalSeconds / 3600).toString().padStart(2,'0');
                const m = Math.floor((globalSeconds % 3600) / 60).toString().padStart(2,'0');
                const s = (globalSeconds % 60).toString().padStart(2,'0');
                document.getElementById('global-timer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function stopGlobalTimer() {
            clearInterval(globalInterval);
            globalInterval = null;
            openLogModal(true); // Abre modal convertendo tempo
            
            document.getElementById('global-stop').classList.add('hidden');
            document.getElementById('global-play').classList.remove('hidden');
            document.getElementById('global-timer').classList.remove('timer-pulse');
        }

        async function openLogModal(fromTimer) {
            if(!activeTicketId) return alert("Selecione um chamado.");
            openModal('time-modal');
            
            // Seta a data para HOJE por padrão
            document.getElementById('modal-date').value = new Date().toISOString().split('T')[0];

            const sel = document.getElementById('modal-activity-select');
            sel.innerHTML = '<option>Carregando...</option>';
            
            const res = await fetch(`/api/ops/tickets/${activeTicketId}/activities`);
            const acts = await res.json();
            sel.innerHTML = '';
            
            if(acts.length === 0) sel.innerHTML = '<option value="new">-- Criar Nova --</option>';
            else {
                acts.forEach(a => sel.innerHTML += `<option value="${a.Id}">${a.Name}</option>`);
                sel.innerHTML += `<option value="new" class="text-indigo-600 font-bold">+ Nova Atividade</option>`;
            }
            toggleNewActivityInput();

            if(fromTimer) {
                // Converte segundos para horas (arredonda para 0.5 mais próximo)
                let h = globalSeconds / 3600;
                h = Math.ceil(h * 2) / 2;
                if(h === 0) h = 0.5;
                document.getElementById('modal-hours').value = h.toFixed(1);
            } else {
                document.getElementById('modal-hours').value = '0.5';
            }
        }

        function toggleNewActivityInput() {
            const val = document.getElementById('modal-activity-select').value;
            const inp = document.getElementById('modal-new-activity-name');
            const hint = document.getElementById('modal-activity-hint');
            
            if(val === 'new') { 
                inp.classList.remove('hidden'); 
                hint.classList.remove('hidden'); 
            } else { 
                inp.classList.add('hidden'); 
                hint.classList.add('hidden'); 
            }
        }

        async function saveLog() {
            const date = document.getElementById('modal-date').value;
            const hours = document.getElementById('modal-hours').value;
            const type = document.getElementById('modal-type').value;
            const actId = document.getElementById('modal-activity-select').value;
            const newAct = document.getElementById('modal-new-activity-name').value;
            const desc = document.getElementById('modal-desc').value;

            if(!hours || parseFloat(hours) <= 0) return alert("Informe as horas.");
            if(!date) return alert("Informe a data.");

            try {
                const res = await fetch('/api/ops/log', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        caseId: activeTicketId,
                        activityId: actId,
                        newActivityName: newAct,
                        hours: hours,
                        isExtra: (type === 'extra'),
                        desc: desc,
                        date: date
                    })
                });
                const json = await res.json();
                if(json.success) {
                    closeModal('time-modal');
                    loadTicketDetails(activeTicketId);
                    // Reseta timer global se foi usado
                    if(globalSeconds > 0) {
                        globalSeconds = 0;
                        document.getElementById('global-timer').innerText = "00:00:00";
                    }
                    showToast("Sucesso", "Horas registradas!");
                } else {
                    alert("Erro: " + (json.error || JSON.stringify(json.errors)));
                }
            } catch(e) { console.error(e); }
        }

        // --- OUTRAS AÇÕES ---
        async function createTicket() {
            const subject = document.getElementById('new-subject').value;
            const clientName = document.getElementById('new-client-name').value;
            const desc = document.getElementById('new-desc').value;

            if(!subject || !clientName) return alert("Preencha Assunto e Cliente.");

            try {
                const res = await fetch('/api/ops/tickets/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ subject, desc, accountId: clientName })
                });
                const json = await res.json();
                if(json.success) {
                    closeModal('new-ticket-modal');
                    changeFilter('my');
                    alert("Chamado Criado com sucesso!");
                } else {
                    alert("Erro ao criar: " + (json.error || "Verifique o nome do cliente."));
                }
            } catch(e) { console.error(e); }
        }

        async function assignTicket() {
            if(!confirm("Puxar este chamado para você?")) return;
            const res = await fetch('/api/ops/tickets/assign', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: activeTicketId })
            });
            if(res.ok) { alert("Chamado atribuído!"); changeFilter('my'); }
        }

        async function postComment() {
            const txt = document.getElementById('quick-comment').value;
            if(!txt) return;
            const res = await fetch('/api/ops/comment', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ caseId: activeTicketId, text: txt })
            });
            if(res.ok) { document.getElementById('quick-comment').value = ''; loadTicketDetails(activeTicketId); }
        }

        // --- UTILS UI ---
        function switchDetailTab(t) {
            document.getElementById('view-info').classList.add('hidden');
            document.getElementById('view-logs').classList.add('hidden');
            document.getElementById('dt-info').className = 'pb-3 text-sm tab-inactive';
            document.getElementById('dt-logs').className = 'pb-3 text-sm tab-inactive';
            
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.getElementById(`dt-${t}`).className = 'pb-3 text-sm tab-active';
        }

        function showToast(title, msg) {
            // Implementação simples de alerta para feedback rápido
            // Em produção poderia ser um elemento flutuante
            console.log(title, msg);
        }

        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            setTimeout(() => { m.querySelector('div').classList.remove('scale-95'); }, 10);
        }
        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('hidden');
        }
        function closeTicketMobile() {
            document.getElementById('ticket-list-panel').classList.remove('hidden');
            document.getElementById('ticket-workspace').classList.add('hidden');
            document.getElementById('ticket-workspace').classList.remove('flex');
        }
    </script>
</body>
</html>